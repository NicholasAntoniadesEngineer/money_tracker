<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messenger - Money Tracker</title>
    <link rel="stylesheet" href="../../shared/vendor/font-awesome/css/all.min.css">
    <link rel="stylesheet" href="../../shared/styles/main-compiled.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script>
        (function() {
            var m = { 'very-small': 13, small: 14, medium: 16, large: 18, 'very-large': 20 };
            var s = localStorage.getItem('money_tracker_fontScale') || 'medium';
            document.documentElement.style.fontSize = (m[s] || 16) + 'px';
        })();
    </script>
</head>
<body>
    <!-- Header will be injected by Header.js -->

    <main class="messenger-main" role="main">
        <section class="messenger-section form-section">
            <div class="messenger-controls" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-md); flex-wrap: wrap; gap: var(--spacing-sm);">
                <div style="display: flex; gap: var(--spacing-sm); align-items: center; flex-wrap: wrap; max-width: 100%;">
                    <button id="new-message-button" class="btn btn-action" style="flex: 0 1 auto; min-width: 0; max-width: 100%;">New Message</button>
                </div>
            </div>

            <div id="conversations-list" class="conversations-list">
                <p>Loading conversations...</p>
            </div>
            <div id="message-thread-container" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-4); padding: var(--space-4); background: var(--color-bg-card); border-radius: var(--radius-lg); box-shadow: var(--shadow-sm); flex-wrap: wrap; gap: var(--space-3);">
                    <div style="display: flex; align-items: center; gap: var(--space-3); flex: 1 1 auto; min-width: 0;">
                        <button id="back-to-conversations" style="background: none; border: none; color: var(--color-text-secondary); cursor: pointer; padding: 0; display: flex; align-items: center; justify-content: center; font-size: var(--text-lg); transition: color var(--duration-fast) var(--ease-default);" onmouseover="this.style.color='var(--color-action)'" onmouseout="this.style.color='var(--color-text-secondary)'">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <h3 id="conversation-partner-name" style="margin: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: var(--color-text-primary); font-size: var(--text-base); font-weight: 600;"> </h3>
                    </div>
                    <div style="display: flex; gap: var(--space-2); flex-wrap: wrap;">
                        <button id="block-user-conversation-btn" class="btn-text btn-text-danger" style="display: none;">Block</button>
                    </div>
                </div>
                <div id="message-thread" class="message-thread">
                    <p>Loading messages...</p>
                </div>
                <div id="message-input-container" class="message-input-container">
                    <!-- Attachment preview area -->
                    <div id="attachment-preview" class="attachment-preview">
                        <i id="attachment-preview-icon" class="fas fa-file attachment-preview-icon"></i>
                        <div class="attachment-preview-info">
                            <div id="attachment-preview-name" class="attachment-preview-name"></div>
                            <div id="attachment-preview-size" class="attachment-preview-size"></div>
                        </div>
                        <button id="remove-attachment-btn" class="attachment-remove-btn" title="Remove">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <textarea id="message-input" class="message-textarea" placeholder="Type your message..." rows="2"></textarea>
                    <div class="message-actions">
                        <input type="file" id="attachment-input" class="hidden-input">
                        <button id="attach-file-button" class="message-action-btn" style="display: none;" title="Attach file">
                            <i class="fas fa-paperclip"></i>
                        </button>
                        <button id="share-data-button" class="message-action-btn" style="display: none;" title="Share data">
                            <i class="fas fa-share-alt"></i>
                        </button>
                        <div class="message-actions-spacer"></div>
                        <button id="send-message-button" class="btn btn-action message-send-btn">
                            <i class="fas fa-paper-plane"></i> Send
                        </button>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- New Message Modal -->
    <div id="new-message-modal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(4px); z-index: 1000; align-items: center; justify-content: center;">
        <div class="modal-content" style="background: var(--color-bg-card); padding: var(--space-6); border-radius: var(--radius-xl); max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: var(--shadow-lg); border-left: 3px solid var(--color-action);">
            <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-5); padding-bottom: var(--space-4); border-bottom: 1px solid var(--color-border-light);">
                <h3 style="margin: 0; display: flex; align-items: center; gap: var(--space-3); color: var(--color-text-primary); font-size: var(--text-lg);"><i class="fas fa-envelope" style="color: var(--color-action);"></i> New Message</h3>
                <button id="close-new-message-modal" class="btn btn-secondary" style="padding: var(--space-2); min-width: auto; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; line-height: 1; border-radius: var(--radius-full);">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group" style="margin-bottom: var(--space-4);">
                    <label for="recipient-email-input" class="form-label" style="display: block; margin-bottom: var(--space-2); font-weight: 500; font-size: var(--text-sm); color: var(--color-text-secondary);">Recipient Email</label>
                    <input type="email" id="recipient-email-input" class="form-input" placeholder="user@example.com" autocomplete="email">
                </div>
                <div class="form-group" style="margin-bottom: var(--space-4);">
                    <label for="new-message-content" class="form-label" style="display: block; margin-bottom: var(--space-2); font-weight: 500; font-size: var(--text-sm); color: var(--color-text-secondary);">Message</label>
                    <textarea id="new-message-content" class="form-input" placeholder="Type your message here..." rows="5" style="resize: vertical; min-height: 120px;"></textarea>
                </div>
            </div>
            <div class="modal-footer" style="display: flex; justify-content: flex-end; gap: var(--space-3); margin-top: var(--space-5); padding-top: var(--space-4); border-top: 1px solid var(--color-border-light);">
                <button id="cancel-new-message-button" class="btn btn-secondary">Cancel</button>
                <button id="send-new-message-button" class="btn btn-action"><i class="fas fa-paper-plane"></i> Send</button>
            </div>
        </div>
    </div>

    <!-- Share Data Modal -->
    <div id="share-data-modal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(4px); z-index: 1000; align-items: center; justify-content: center;">
        <div class="modal-content" style="background: var(--color-bg-card); padding: var(--space-6); border-radius: var(--radius-xl); max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: var(--shadow-lg); border-left: 3px solid var(--color-action);">
            <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-5); padding-bottom: var(--space-4); border-bottom: 1px solid var(--color-border-light);">
                <h3 style="margin: 0; display: flex; align-items: center; gap: var(--space-3); color: var(--color-text-primary); font-size: var(--text-lg);"><i class="fas fa-share-alt" style="color: var(--color-action);"></i> Share Data</h3>
                <button id="close-share-data-modal" class="btn btn-secondary" style="padding: var(--space-2); min-width: auto; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; line-height: 1; border-radius: var(--radius-full);">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group" style="margin-bottom: var(--space-4);">
                    <label for="share-data-email" class="form-label" style="display: block; margin-bottom: var(--space-2); font-weight: 500; font-size: var(--text-sm); color: var(--color-text-secondary);">User Email</label>
                    <input type="email" id="share-data-email" class="form-input" placeholder="user@example.com" autocomplete="email" required readonly style="background: var(--color-bg-surface); cursor: not-allowed;">
                </div>

                <div class="form-group" style="margin-bottom: var(--space-4);">
                    <label for="share-data-access-level" class="form-label" style="display: block; margin-bottom: var(--space-2); font-weight: 500; font-size: var(--text-sm); color: var(--color-text-secondary);">Access Level</label>
                    <select id="share-data-access-level" class="form-select">
                        <option value="read">Read Only</option>
                        <option value="read_write">Read/Write</option>
                        <option value="read_write_delete">Read/Write/Delete</option>
                    </select>
                </div>

                <div class="form-group" style="margin-bottom: var(--space-5); padding: var(--space-4); background: var(--color-bg-surface); border-radius: var(--radius-lg); border-left: 2px solid var(--color-action);">
                    <label style="display: flex; align-items: center; gap: var(--space-2); cursor: pointer;">
                        <input type="checkbox" id="share-data-all-data" style="cursor: pointer;">
                        <span style="font-weight: 500; color: var(--color-text-primary);">Share All Data</span>
                    </label>
                </div>

                <div class="form-group" style="margin-bottom: var(--space-4);">
                    <label class="form-label" style="display: block; margin-bottom: var(--space-3); font-weight: 500; font-size: var(--text-sm); color: var(--color-text-secondary);">Share Options</label>
                    <div style="display: flex; flex-direction: column; gap: var(--space-3); padding: var(--space-4); background: var(--color-bg-surface); border-radius: var(--radius-lg);">
                        <label style="display: flex; align-items: center; gap: var(--space-2); cursor: pointer;">
                            <input type="checkbox" id="share-data-months" checked style="cursor: pointer;">
                            <span>Months</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: var(--space-2); cursor: pointer;">
                            <input type="checkbox" id="share-data-pots" style="cursor: pointer;">
                            <span>Pots</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: var(--space-2); cursor: pointer;">
                            <input type="checkbox" id="share-data-settings" style="cursor: pointer;">
                            <span>Settings</span>
                        </label>
                    </div>
                </div>

                <div id="share-data-months-container" style="margin-bottom: var(--space-4);">
                    <label class="form-label" style="display: block; margin-bottom: var(--space-3); font-weight: 500; font-size: var(--text-sm); color: var(--color-text-secondary);">Select Months</label>
                    <div id="share-data-months-checkboxes" style="display: flex; flex-direction: column; gap: var(--space-2); max-height: 200px; overflow-y: auto; padding: var(--space-4); background: var(--color-bg-surface); border-radius: var(--radius-lg); border: 1px solid var(--color-border-light);">
                        <!-- Month checkboxes will be added here -->
                    </div>
                </div>

                <div id="share-data-form-status" style="margin-top: var(--space-4);"></div>
            </div>
            <div class="modal-footer" style="display: flex; justify-content: flex-end; gap: var(--space-3); margin-top: var(--space-5); padding-top: var(--space-4); border-top: 1px solid var(--color-border-light);">
                <button id="cancel-share-data-button" class="btn btn-secondary">Cancel</button>
                <button id="save-share-data-button" class="btn btn-action"><i class="fas fa-share-alt"></i> Share Data</button>
            </div>
        </div>
    </div>



    <!-- Scripts -->
    <!-- Global Logging Configuration - MUST load first -->
    <script src="../../shared/config/loggingConfig.js"></script>

    <script src="../../database/config/supabaseConfig.js"></script>
    <script src="../../shared/services/authService.js"></script>
    <script src="../../database/config/databaseConfigBase.js"></script>
    <script src="../../database/config/moneyTrackerDatabaseConfig.js"></script>
    <script src="../../database/utils/databaseConfigHelper.js"></script>
    <script src="../../database/databaseModule.js"></script>

    <!-- Core Utilities -->
    <script src="../../shared/config/moduleRegistry.js"></script>
    <script src="../../shared/config/constants.js"></script>
    <script src="../../shared/utils/logger.js"></script>
    <script src="../../shared/utils/errorHandler.js"></script>
    <script src="../../shared/utils/validators.js"></script>
    
    <!-- Database Service -->
    <script src="../../database/services/databaseService.js"></script>
    <script src="../../database/services/dataSharingService.js"></script>
    <script src="../../database/services/fieldLockingService.js"></script>
    
    <!-- Notification Services -->
    <script src="../../database/services/notificationTypeRegistry.js"></script>
    <script src="../../database/services/notificationService.js"></script>
    <script src="../../database/services/notificationPreferenceService.js"></script>
    <script src="../../database/services/notificationChannelService.js"></script>
    <script src="../../database/services/notificationProcessor.js"></script>

    <!-- E2E Encryption Module -->
    <script src="../../encryption/config/encryptionConfigBase.js"></script>
    <script src="../../encryption/config/moneyTrackerEncryptionConfig.js"></script>
    <script src="../../encryption/utils/encryptionConfigHelper.js"></script>
    <script src="../../encryption/services/cryptoLibraryLoader.js"></script>
    <script src="../../encryption/services/keyDerivationService.js"></script>
    <script src="../../encryption/services/cryptoPrimitivesService.js"></script>
    <script src="../../encryption/services/keyStorageService.js"></script>
    <script src="../../encryption/services/passwordCryptoService.js"></script>
    <script src="../../encryption/services/historicalKeysService.js"></script>
    <script src="../../encryption/services/keyBackupService.js"></script>
    <script src="../../encryption/services/keyManagementService.js"></script>
    <script src="../../encryption/facade/encryptionFacade.js"></script>
    <script src="../../encryption/facade/nullEncryptionFacade.js"></script>
    <script src="../../encryption/encryptionModule.js"></script>
    <script src="../../encryption/initEncryption.js"></script>

    <!-- Messaging Service -->
    <script src="../services/messagingService.js"></script>
    <script src="../services/devicePairingService.js"></script>
    <script src="../services/attachmentService.js"></script>

    <!-- Initialize Database Module -->
    <script src="../../database/initDatabase.js"></script>
    
    <!-- Payments Module Configuration -->
    <script src="../../payments/config/paymentsConfigBase.js"></script>
    <script src="../../payments/config/moneyTrackerConfig.js"></script>
    <script src="../../payments/utils/configHelper.js"></script>
    <script src="../../payments/paymentsModule.js"></script>
    
    <!-- Payments Services -->
    <script src="../../payments/services/stripeService.js"></script>
    <script src="../../payments/services/paymentService.js"></script>
    <script src="../../payments/services/subscriptionService.js"></script>
    <script src="../../payments/utils/subscriptionChecker.js"></script>
    
    <!-- Initialize Payments Module -->
    <script src="../../payments/initPayments.js"></script>
    <script src="../../payments/utils/waitForPaymentsInit.js"></script>
    <script src="../../shared/utils/subscriptionGuard.js"></script>
    <script src="../../shared/utils/permissionService.js"></script>
    <script src="../../shared/utils/authGuard.js"></script>
    <script src="../../shared/utils/networkUtils.js"></script>
    <script src="../../shared/utils/offlineHandler.js"></script>
    
    <!-- Header Component -->
    <script>
        console.log('[MessengerPage] Loading Header.js script...');
        const headerScriptStart = Date.now();
    </script>
    <script src="../../shared/header/header.js" onload="console.log('[MessengerPage] Header.js loaded in', Date.now() - headerScriptStart, 'ms'); console.log('[MessengerPage] window.Header after load:', typeof window.Header);" onerror="console.error('[MessengerPage] ERROR loading Header.js');"></script>
    
    <!-- Messenger Controller -->
    <script>
        console.log('[MessengerPage] Loading messengerController.js script...');
        const controllerScriptStart = Date.now();
    </script>
    <script src="../controllers/messengerController.js" onload="console.log('[MessengerPage] messengerController.js loaded in', Date.now() - controllerScriptStart, 'ms'); console.log('[MessengerPage] window.MessengerController after load:', typeof window.MessengerController);" onerror="console.error('[MessengerPage] ERROR loading messengerController.js');"></script>
    <script>
        // Wait for scripts to load with detailed logging
        function waitFor(condition, name, timeout = 5000) {
            return new Promise((resolve, reject) => {
                const startTime = Date.now();
                let checkCount = 0;
                const check = () => {
                    checkCount++;
                    const elapsed = Date.now() - startTime;
                    const isAvailable = condition();
                    
                    // Log every 10 checks (every second) or on first check
                    if (checkCount === 1 || checkCount % 10 === 0) {
                        console.log(`[MessengerPage] Waiting for ${name}... (check ${checkCount}, ${elapsed}ms elapsed)`);
                        console.log(`[MessengerPage] Current window state:`, {
                            hasHeader: typeof window.Header !== 'undefined',
                            hasMessengerController: typeof window.MessengerController !== 'undefined',
                            headerType: typeof window.Header,
                            messengerControllerType: typeof window.MessengerController,
                            windowKeys: Object.keys(window).filter(k => k.includes('Header') || k.includes('Messenger'))
                        });
                    }
                    
                    if (isAvailable) {
                        const totalTime = Date.now() - startTime;
                        console.log(`[MessengerPage] ✅ ${name} is now available after ${totalTime}ms (${checkCount} checks)`);
                        resolve();
                    } else if (elapsed > timeout) {
                        const totalTime = Date.now() - startTime;
                        console.error(`[MessengerPage] ❌ Timeout waiting for ${name} after ${totalTime}ms (${checkCount} checks)`);
                        console.error(`[MessengerPage] Final window state:`, {
                            hasHeader: typeof window.Header !== 'undefined',
                            hasMessengerController: typeof window.MessengerController !== 'undefined',
                            headerType: typeof window.Header,
                            messengerControllerType: typeof window.MessengerController,
                            allWindowKeys: Object.keys(window).slice(0, 50) // First 50 keys for debugging
                        });
                        reject(new Error(`Timeout waiting for ${name} after ${totalTime}ms`));
                    } else {
                        setTimeout(check, 100);
                    }
                };
                check();
            });
        }

        // Log script loading progress
        document.addEventListener('readystatechange', () => {
            console.log('[MessengerPage] Document readyState changed to:', document.readyState);
            console.log('[MessengerPage] Window state at readyState change:', {
                hasHeader: typeof window.Header !== 'undefined',
                hasMessengerController: typeof window.MessengerController !== 'undefined',
                headerType: typeof window.Header,
                messengerControllerType: typeof window.MessengerController
            });
        });

        // Log immediately when this script executes
        console.log('[MessengerPage] ========== INITIALIZATION SCRIPT EXECUTING ==========');
        console.log('[MessengerPage] Current readyState:', document.readyState);
        console.log('[MessengerPage] Window state at script execution:', {
            hasHeader: typeof window.Header !== 'undefined',
            hasMessengerController: typeof window.MessengerController !== 'undefined',
            headerType: typeof window.Header,
            messengerControllerType: typeof window.MessengerController,
            allWindowKeys: Object.keys(window).filter(k => k.includes('Header') || k.includes('Messenger') || k.includes('Database') || k.includes('Auth'))
        });

        document.addEventListener('DOMContentLoaded', async () => {
            console.log('[MessengerPage] ========== DOMContentLoaded FIRED ==========');
            console.log('[MessengerPage] Document ready state:', document.readyState);
            console.log('[MessengerPage] Script loading status:', {
                totalScripts: document.scripts.length,
                loadedScripts: Array.from(document.scripts).map(s => ({
                    src: s.src || 'inline',
                    readyState: s.readyState,
                    async: s.async,
                    defer: s.defer
                }))
            });
            console.log('[MessengerPage] Initial window state check:', {
                hasHeader: typeof window.Header !== 'undefined',
                hasMessengerController: typeof window.MessengerController !== 'undefined',
                headerType: typeof window.Header,
                messengerControllerType: typeof window.MessengerController,
                headerConstructor: window.Header ? window.Header.constructor.name : 'N/A',
                headerMethods: window.Header ? Object.getOwnPropertyNames(window.Header).filter(n => typeof window.Header[n] === 'function') : []
            });
            
            // Check if all scripts have loaded
            const allScriptsLoaded = Array.from(document.scripts).every(s => {
                return !s.src || s.readyState === 'complete' || s.readyState === 'loaded';
            });
            console.log('[MessengerPage] All scripts loaded check:', {
                allLoaded: allScriptsLoaded,
                scriptStates: Array.from(document.scripts).map(s => ({
                    src: s.src ? s.src.split('/').pop() : 'inline',
                    readyState: s.readyState
                }))
            });

            try {
                console.log('[MessengerPage] Step 1: Waiting for Header to be available...');
                const headerWaitStart = Date.now();
                await waitFor(() => typeof window.Header !== 'undefined', 'Header', 10000);
                const headerWaitTime = Date.now() - headerWaitStart;
                console.log(`[MessengerPage] Header wait completed in ${headerWaitTime}ms`);
                
                console.log('[MessengerPage] Step 2: Checking Header availability and initializing...');
                console.log('[MessengerPage] Header object:', {
                    exists: window.Header !== undefined,
                    type: typeof window.Header,
                    hasInit: window.Header && typeof window.Header.init === 'function',
                    hasStaticInit: window.Header && typeof window.Header.init === 'function',
                    constructor: window.Header ? window.Header.constructor.name : 'N/A'
                });
                
                // Initialize Header first (it may have already auto-initialized, but init() is idempotent)
                if (window.Header && typeof window.Header.init === 'function') {
                    console.log('[MessengerPage] Calling Header.init()...');
                    const headerInitStart = Date.now();
                    await window.Header.init();
                    const headerInitTime = Date.now() - headerInitStart;
                    console.log(`[MessengerPage] ✅ Header.init() completed in ${headerInitTime}ms`);
                } else {
                    console.warn('[MessengerPage] ⚠️ Header.init() is not available:', {
                        hasHeader: window.Header !== undefined,
                        headerType: typeof window.Header,
                        hasInitMethod: window.Header && typeof window.Header.init
                    });
                }

                console.log('[MessengerPage] Step 4: Waiting for MessengerController to be available...');
                const controllerWaitStart = Date.now();
                await waitFor(() => typeof window.MessengerController !== 'undefined', 'MessengerController', 10000);
                const controllerWaitTime = Date.now() - controllerWaitStart;
                console.log(`[MessengerPage] MessengerController wait completed in ${controllerWaitTime}ms`);

                console.log('[MessengerPage] Step 5: Checking MessengerController availability and initializing...');
                console.log('[MessengerPage] MessengerController object:', {
                    exists: window.MessengerController !== undefined,
                    type: typeof window.MessengerController,
                    hasInit: window.MessengerController && typeof window.MessengerController.init === 'function'
                });

                // Initialize MessengerController
                if (window.MessengerController && typeof window.MessengerController.init === 'function') {
                    console.log('[MessengerPage] Calling MessengerController.init()...');
                    const controllerInitStart = Date.now();
                    await window.MessengerController.init();
                    const controllerInitTime = Date.now() - controllerInitStart;
                    console.log(`[MessengerPage] ✅ MessengerController.init() completed in ${controllerInitTime}ms`);

                    // Set up periodic key rotation check (every 5 minutes)
                    // This checks if YOUR keys need rotation based on the configured interval
                    // Other user's key rotations are handled transparently via epoch-based decryption
                    const ROTATION_CHECK_INTERVAL = 5 * 60 * 1000; // 5 minutes
                    let lastRotationCheck = 0;

                    const checkKeyRotation = async () => {
                        const now = Date.now();
                        // Throttle: only check if 5 minutes have passed since last check
                        if (now - lastRotationCheck < ROTATION_CHECK_INTERVAL) {
                            return;
                        }
                        lastRotationCheck = now;

                        try {
                            // Check if EncryptionModule is initialized
                            if (!window.EncryptionModule?.isInitialized?.()) {
                                return; // Skip rotation check if module not initialized
                            }

                            const facade = window.getEncryptionFacade?.();
                            if (!facade?.checkAndRotateIfNeeded) return;

                            const result = await facade.checkAndRotateIfNeeded();
                            if (result.rotated) {
                                console.log(`[MessengerPage] Auto-rotated keys to epoch ${result.newEpoch}`);
                            }
                        } catch (error) {
                            console.warn('[MessengerPage] Key rotation check failed:', error);
                        }
                    };

                    // Check rotation on page load (already done in EncryptionModule, but also do it here)
                    checkKeyRotation();

                    // Set up periodic check while page is open
                    setInterval(checkKeyRotation, ROTATION_CHECK_INTERVAL);

                    // Also check on message receive (throttled by the function above)
                    const originalSubscribe = window.MessagingService?.subscribeToMessages;
                    if (originalSubscribe) {
                        window.MessagingService.subscribeToMessages = async function(userId, callback) {
                            const wrappedCallback = (payload) => {
                                // Check rotation on new message (throttled)
                                checkKeyRotation();
                                // Call original callback
                                if (callback) callback(payload);
                            };
                            return originalSubscribe.call(this, userId, wrappedCallback);
                        };
                    }

                    console.log('[MessengerPage] ✅ Key rotation monitoring enabled (checks every 5 min)');
                    console.log('[MessengerPage] ========== INITIALIZATION COMPLETE ==========');
                } else {
                    console.error('[MessengerPage] ❌ MessengerController.init() is not available:', {
                        hasController: window.MessengerController !== undefined,
                        controllerType: typeof window.MessengerController,
                        hasInitMethod: window.MessengerController && typeof window.MessengerController.init
                    });
                    throw new Error('MessengerController.init() is not available');
                }
            } catch (error) {
                console.error('[MessengerPage] ========== INITIALIZATION ERROR ==========');
                console.error('[MessengerPage] Error type:', error.constructor.name);
                console.error('[MessengerPage] Error message:', error.message);
                console.error('[MessengerPage] Error stack:', error.stack);
                console.error('[MessengerPage] Final window state at error:', {
                    hasHeader: typeof window.Header !== 'undefined',
                    hasMessengerController: typeof window.MessengerController !== 'undefined',
                    headerType: typeof window.Header,
                    messengerControllerType: typeof window.MessengerController
                });
                alert('Failed to initialize the application. Please refresh the page or check your connection.');
            }
        });
    </script>
</body>
</html>

