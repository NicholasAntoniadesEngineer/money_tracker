<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Device Pairing - Money Tracker</title>
    <link rel="stylesheet" href="../../shared/vendor/font-awesome/css/all.min.css">
    <link rel="stylesheet" href="../../shared/styles/main.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        .pairing-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-lg);
            background: var(--background-color);
        }

        .pairing-card {
            background: var(--surface-color);
            border-radius: var(--border-radius);
            padding: var(--spacing-xl);
            max-width: 600px;
            width: 100%;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .pairing-header {
            text-align: center;
            margin-bottom: var(--spacing-xl);
        }

        .pairing-header h1 {
            font-size: 2rem;
            margin-bottom: var(--spacing-sm);
            color: var(--text-color);
        }

        .pairing-header p {
            color: var(--text-color-secondary);
            font-size: 1rem;
        }

        .pairing-view {
            display: none;
        }

        .pairing-view.active {
            display: block;
        }

        .method-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-md);
            margin: var(--spacing-lg) 0;
        }

        .method-card {
            padding: var(--spacing-lg);
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .method-card:hover {
            border-color: var(--primary-color);
            background: var(--hover-overlay);
        }

        .method-card .method-icon {
            font-size: 3rem;
            margin-bottom: var(--spacing-md);
        }

        .method-card h3 {
            font-size: 1.2rem;
            margin-bottom: var(--spacing-sm);
            color: var(--text-color);
        }

        .method-card p {
            font-size: 0.9rem;
            color: var(--text-color-secondary);
            line-height: 1.4;
        }

        .qr-code-container {
            text-align: center;
            margin: var(--spacing-xl) 0;
        }

        #qr-canvas {
            max-width: 300px;
            height: auto;
            margin: 0 auto;
            display: block;
        }

        #qr-reader {
            max-width: 500px;
            margin: 0 auto;
        }

        .password-input-group {
            margin: var(--spacing-md) 0;
        }

        .password-input-group label {
            display: block;
            margin-bottom: var(--spacing-sm);
            font-weight: 600;
            color: var(--text-color);
        }

        .password-input-group input {
            width: 100%;
            padding: var(--spacing-md);
            border: var(--border-width-standard) solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 1rem;
        }

        .password-strength {
            margin-top: var(--spacing-sm);
            font-size: 0.875rem;
        }

        .password-strength.weak { color: var(--error-color); }
        .password-strength.medium { color: #f59e0b; }
        .password-strength.strong { color: var(--success-color); }

        .instruction-text {
            text-align: center;
            color: var(--text-color-secondary);
            margin: var(--spacing-lg) 0;
            line-height: 1.6;
        }

        .pairing-buttons {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
            margin-top: var(--spacing-lg);
        }

        .pairing-status {
            text-align: center;
            margin-top: var(--spacing-md);
            min-height: 1.5rem;
            padding: var(--spacing-sm);
            border-radius: var(--border-radius);
        }

        .pairing-status.success {
            background: var(--success-color);
            color: white;
        }

        .pairing-status.error {
            background: var(--error-color);
            color: white;
        }

        .pairing-status.info {
            background: var(--primary-color);
            color: white;
        }

        .back-link {
            text-align: center;
            margin-top: var(--spacing-xl);
            padding-top: var(--spacing-lg);
            border-top: var(--border-width-standard) solid var(--border-color);
        }

        .back-link a {
            color: var(--text-color-secondary);
            text-decoration: none;
            font-size: 0.9rem;
        }

        .back-link a:hover {
            color: var(--primary-color);
        }

        @media (max-width: 768px) {
            .method-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Debug panel for mobile - hidden by default */
        .debug-panel {
            display: none;
            background: #1a1a2e;
            color: #0f0;
            font-family: monospace;
            font-size: 11px;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            max-height: 200px;
            overflow-y: auto;
            text-align: left;
            word-break: break-all;
        }
        .debug-panel.visible {
            display: block;
        }
        .debug-panel .debug-line {
            margin: 2px 0;
        }
        .debug-panel .debug-error {
            color: #f55;
        }
        .debug-panel .debug-success {
            color: #5f5;
        }
        .debug-panel .debug-warn {
            color: #ff5;
        }
        .debug-toggle {
            font-size: 10px;
            color: var(--text-color-secondary);
            cursor: pointer;
            text-align: center;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="pairing-container">
        <div class="pairing-card">
            <div class="pairing-header">
                <h1>üîê Device Pairing</h1>
                <p>Sync your encryption keys across devices</p>
                <div class="debug-toggle" onclick="toggleDebugPanel()">[ Show Debug Info ]</div>
            </div>

            <!-- Debug panel for mobile troubleshooting -->
            <div id="debug-panel" class="debug-panel"></div>

            <!-- Choose Action View -->
            <div id="choose-action-view" class="pairing-view active">
                <!-- Message shown when backup exists (secondary device) -->
                <div id="backup-exists-notice" style="display: none; background: var(--primary-color); color: white; padding: var(--spacing-md); border-radius: var(--border-radius); margin-bottom: var(--spacing-lg); text-align: center;">
                    <p style="margin: 0;"><strong>üîë Encryption keys found!</strong></p>
                    <p style="margin: var(--spacing-sm) 0 0 0; font-size: 0.9rem;">
                        You already have encryption set up on another device. Restore your keys to sync encrypted messages.
                    </p>
                </div>
                <div class="instruction-text">
                    <p><strong>Do you have encryption keys on another device?</strong></p>
                </div>
                <div class="pairing-buttons">
                    <button id="new-device-btn" class="btn btn-primary btn-lg">
                        <i class="fas fa-plus"></i> Setup New Device
                    </button>
                    <button id="existing-device-btn" class="btn btn-secondary btn-lg">
                        <i class="fas fa-mobile-alt"></i> Restore from Another Device
                    </button>
                </div>
                <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--border-color);">
                    <p style="font-size: 0.85rem; color: var(--text-color-secondary); margin-bottom: 10px;">
                        Having trouble? If messages aren't decrypting, try resetting your local keys:
                    </p>
                    <button id="reset-keys-btn" class="btn btn-danger" style="font-size: 0.85rem;">
                        <i class="fas fa-trash"></i> Reset Local Keys
                    </button>
                    <div id="reset-status" class="pairing-status" style="margin-top: 10px;"></div>
                </div>
            </div>

            <!-- Choose Backup Method View (for new device) -->
            <div id="choose-backup-method-view" class="pairing-view">
                <div class="instruction-text">
                    <p><strong>Choose how to backup your keys:</strong></p>
                </div>
                <div class="method-grid">
                    <div class="method-card" id="qr-backup-method">
                        <div class="method-icon">üì±</div>
                        <h3>QR Code</h3>
                        <p>Show QR code to pair another device instantly</p>
                    </div>
                    <div class="method-card" id="password-backup-method">
                        <div class="method-icon">üîë</div>
                        <h3>Password</h3>
                        <p>Create password-protected backup for recovery</p>
                    </div>
                </div>
                <div class="pairing-buttons">
                    <button id="back-to-action-btn" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Back
                    </button>
                </div>
            </div>

            <!-- Choose Restore Method View (for existing device) -->
            <div id="choose-restore-method-view" class="pairing-view">
                <div class="instruction-text">
                    <p><strong>Choose how to restore your keys:</strong></p>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: var(--spacing-md); margin: var(--spacing-lg) 0;">
                    <div class="method-card" id="qr-restore-method">
                        <div class="method-icon">üì∑</div>
                        <h3>Scan QR Code</h3>
                        <p>Scan QR code from your primary device</p>
                    </div>
                    <div class="method-card" id="password-restore-method">
                        <div class="method-icon">üîì</div>
                        <h3>Password</h3>
                        <p>Restore from login password</p>
                    </div>
                    <div class="method-card" id="recovery-key-restore-method">
                        <div class="method-icon">üîë</div>
                        <h3>Recovery Key</h3>
                        <p>Use your 24-word recovery key</p>
                    </div>
                </div>
                <div class="pairing-buttons">
                    <button id="back-to-action-btn-2" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Back
                    </button>
                </div>
            </div>

            <!-- QR Code Generation View -->
            <div id="qr-generation-view" class="pairing-view">
                <div class="instruction-text">
                    <p><strong>Scan this QR code with your other device:</strong></p>
                </div>
                <div class="qr-code-container">
                    <canvas id="qr-canvas"></canvas>
                </div>
                <div class="instruction-text">
                    <p style="font-size: 0.9rem; color: var(--error-color);">
                        ‚ö†Ô∏è This QR code expires in 10 minutes for security
                    </p>
                    <p style="font-size: 0.9rem; margin-top: var(--spacing-sm);">
                        Open Device Pairing on your other device and choose "Scan QR Code"
                    </p>
                </div>
                <div class="pairing-buttons">
                    <button id="done-qr-btn" class="btn btn-primary">
                        <i class="fas fa-check"></i> Done
                    </button>
                    <button id="back-from-qr-gen-btn" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Back
                    </button>
                </div>
            </div>

            <!-- QR Code Scanning View -->
            <div id="qr-scanning-view" class="pairing-view">
                <div class="instruction-text">
                    <p><strong>Scan the QR code from your other device:</strong></p>
                </div>
                <div id="qr-reader"></div>
                <div id="qr-scan-status" class="pairing-status"></div>
                <div class="pairing-buttons">
                    <button id="back-from-qr-scan-btn" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Back
                    </button>
                </div>
            </div>

            <!-- Password Backup Creation View -->
            <div id="password-backup-view" class="pairing-view">
                <div class="instruction-text">
                    <p><strong>Create a password to protect your keys:</strong></p>
                </div>
                <div class="password-input-group">
                    <label for="backup-password">Password (min 8 characters)</label>
                    <input type="password" id="backup-password" placeholder="Enter password">
                    <div id="password-strength-indicator" class="password-strength"></div>
                </div>
                <div class="password-input-group">
                    <label for="backup-password-confirm">Confirm Password</label>
                    <input type="password" id="backup-password-confirm" placeholder="Confirm password">
                </div>
                <div id="backup-status" class="pairing-status"></div>
                <div class="pairing-buttons">
                    <button id="create-backup-btn" class="btn btn-primary">
                        <i class="fas fa-save"></i> Create Backup
                    </button>
                    <button id="back-from-backup-btn" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Back
                    </button>
                </div>
            </div>

            <!-- Password Restore View -->
            <div id="password-restore-view" class="pairing-view">
                <div class="instruction-text">
                    <p><strong>Enter your login password to restore keys:</strong></p>
                </div>
                <div class="password-input-group">
                    <label for="restore-password">Password</label>
                    <input type="password" id="restore-password" placeholder="Enter your login password">
                </div>
                <div id="restore-status" class="pairing-status"></div>
                <div class="pairing-buttons">
                    <button id="restore-backup-btn" class="btn btn-primary">
                        <i class="fas fa-unlock"></i> Restore Keys
                    </button>
                    <button id="back-from-restore-btn" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Back
                    </button>
                </div>
            </div>

            <!-- Recovery Key Restore View -->
            <div id="recovery-key-restore-view" class="pairing-view">
                <div class="instruction-text">
                    <p><strong>Enter your 24-word recovery key:</strong></p>
                    <p style="font-size: 0.9rem; color: var(--text-color-secondary); margin-top: var(--spacing-sm);">
                        Paste or type all 24 words separated by spaces
                    </p>
                </div>
                <div style="margin: var(--spacing-lg) 0;">
                    <label for="recovery-key-input" style="display: block; margin-bottom: var(--spacing-sm); font-weight: 500;">Recovery Key</label>
                    <textarea
                        id="recovery-key-input"
                        placeholder="word1 word2 word3 ..."
                        rows="6"
                        style="width: 100%; padding: var(--spacing-md); border: 2px solid var(--border-color); border-radius: var(--border-radius); font-family: 'Courier New', monospace; font-size: 1rem; resize: vertical;"
                    ></textarea>
                    <div id="recovery-key-word-count" style="font-size: 0.85rem; color: var(--text-color-secondary); margin-top: var(--spacing-xs);">
                        0 / 24 words
                    </div>
                </div>
                <div id="recovery-restore-status" class="pairing-status"></div>
                <div class="pairing-buttons">
                    <button id="restore-recovery-key-btn" class="btn btn-primary" disabled>
                        <i class="fas fa-key"></i> Restore with Recovery Key
                    </button>
                    <button id="back-from-recovery-restore-btn" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Back
                    </button>
                </div>
            </div>

            <div class="back-link">
                <a href="../../landing/index.html">
                    <i class="fas fa-home"></i> Return to Dashboard
                </a>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../../shared/config/loggingConfig.js"></script>
    <script src="../../database/config/supabaseConfig.js"></script>
    <script src="../../database/services/databaseService.js"></script>
    <script src="../../shared/services/authService.js"></script>
    <!-- E2E Encryption Module -->
    <script src="../../encryption/config/encryptionConfigBase.js"></script>
    <script src="../../encryption/config/moneyTrackerEncryptionConfig.js"></script>
    <script src="../../encryption/utils/encryptionConfigHelper.js"></script>
    <script src="../../encryption/services/cryptoLibraryLoader.js"></script>
    <script src="../../encryption/services/keyDerivationService.js"></script>
    <script src="../../encryption/services/cryptoPrimitivesService.js"></script>
    <script src="../../encryption/services/keyStorageService.js"></script>
    <script src="../../encryption/services/historicalKeysService.js"></script>
    <script src="../../encryption/services/passwordCryptoService.js"></script>
    <script src="../../encryption/services/keyBackupService.js"></script>
    <script src="../../encryption/services/keyManagementService.js"></script>
    <script src="../../encryption/facade/encryptionFacade.js"></script>
    <script src="../../encryption/facade/nullEncryptionFacade.js"></script>
    <script src="../../encryption/encryptionModule.js"></script>
    <script src="../../encryption/initEncryption.js"></script>

    <script>
        let qrScanner = null;
        let debugVisible = false;

        // Debug panel functions for mobile troubleshooting
        function toggleDebugPanel() {
            const panel = document.getElementById('debug-panel');
            const toggle = document.querySelector('.debug-toggle');
            debugVisible = !debugVisible;
            if (debugVisible) {
                panel.classList.add('visible');
                toggle.textContent = '[ Hide Debug Info ]';
            } else {
                panel.classList.remove('visible');
                toggle.textContent = '[ Show Debug Info ]';
            }
        }

        function debugLog(message, type = 'info') {
            const panel = document.getElementById('debug-panel');
            if (!panel) return;
            const line = document.createElement('div');
            line.className = 'debug-line' + (type === 'error' ? ' debug-error' : type === 'success' ? ' debug-success' : type === 'warn' ? ' debug-warn' : '');
            const time = new Date().toLocaleTimeString();
            line.textContent = `[${time}] ${message}`;
            panel.appendChild(line);
            panel.scrollTop = panel.scrollHeight;
        }

        function debugClear() {
            const panel = document.getElementById('debug-panel');
            if (panel) panel.innerHTML = '';
        }

        // Reset local keys function
        async function resetLocalKeys() {
            const statusEl = document.getElementById('reset-status');

            if (!confirm('This will delete all local encryption keys on this device.\n\nYou will need to restore from password backup or QR code afterwards.\n\nContinue?')) {
                return;
            }

            try {
                statusEl.textContent = 'Clearing local keys...';
                statusEl.className = 'pairing-status info';
                debugLog('Resetting local keys...');

                // Clear IndexedDB stores first using new encryption module
                if (window.KeyStorageService && window.KeyStorageService.clearAll) {
                    await window.KeyStorageService.clearAll();
                    debugLog('KeyStorageService.clearAll() done', 'success');
                }

                // CRITICAL: Close the database connection before attempting deletion
                // iOS Safari blocks deletion if there's an open connection
                if (window.KeyStorageService && window.KeyStorageService._db) {
                    debugLog('Closing database connection...');
                    window.KeyStorageService._db.close();
                    window.KeyStorageService._db = null;
                    debugLog('Database connection closed', 'success');
                }

                // Now try to delete the entire database
                const dbName = 'MoneyTrackerEncryption';
                await new Promise((resolve) => {
                    const request = indexedDB.deleteDatabase(dbName);
                    request.onsuccess = () => {
                        debugLog(`Deleted IndexedDB: ${dbName}`, 'success');
                        resolve();
                    };
                    request.onerror = () => {
                        debugLog(`Failed to delete IndexedDB: ${request.error}`, 'error');
                        resolve(); // Continue anyway - stores were cleared
                    };
                    request.onblocked = () => {
                        debugLog('IndexedDB deletion still blocked - stores were cleared anyway', 'warn');
                        resolve(); // Continue - the stores were cleared even if DB delete blocked
                    };
                });

                // Reset KeyManagementService state
                if (window.KeyManagementService) {
                    window.KeyManagementService.initialized = false;
                    window.KeyManagementService._identityKeyPair = null;
                }

                statusEl.innerHTML = '‚úì Local keys cleared!<br><small>Refreshing page in 2 seconds...</small>';
                statusEl.className = 'pairing-status success';
                debugLog('Local keys reset complete', 'success');
                debugLog('Refreshing page to reinitialize...');

                // Auto-refresh to reinitialize with clean state
                setTimeout(() => {
                    window.location.reload();
                }, 2000);

            } catch (error) {
                console.error('[DevicePairing] Reset keys error:', error);
                debugLog(`Reset failed: ${error.message}`, 'error');
                statusEl.textContent = '‚úó Error: ' + error.message;
                statusEl.className = 'pairing-status error';
            }
        }

        // View management
        function showView(viewId) {
            document.querySelectorAll('.pairing-view').forEach(view => {
                view.classList.remove('active');
            });
            document.getElementById(viewId).classList.add('active');
        }

        // Password strength checker
        function checkPasswordStrength(password) {
            if (!password) return '';
            if (password.length < 8) return 'Password must be at least 8 characters';
            if (password.length < 12) return '<span class="weak">Weak - consider longer password</span>';
            if (!/[A-Z]/.test(password) || !/[a-z]/.test(password) || !/[0-9]/.test(password)) {
                return '<span class="medium">Medium - add uppercase, lowercase, and numbers</span>';
            }
            return '<span class="strong">Strong password!</span>';
        }

        // Initialize
        async function initialize() {
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('[DevicePairing] üîß PAGE INITIALIZATION STARTED');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('[DevicePairing] User arrived at device pairing page');
            console.log('[DevicePairing] Referrer:', document.referrer || 'direct navigation');

            // Detect mobile device
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            console.log('[DevicePairing] Device type:', isMobile ? 'Mobile' : 'Desktop');
            console.log('[DevicePairing] User agent:', navigator.userAgent);

            // Log key diagnostic info to debug panel
            debugLog('=== INITIALIZATION STARTED ===');
            debugLog(`Device: ${isMobile ? 'MOBILE' : 'Desktop'}`);
            debugLog(`Protocol: ${window.location.protocol}`);
            debugLog(`Host: ${window.location.hostname}`);
            debugLog(`UA: ${navigator.userAgent.substring(0, 50)}...`);

            try {
                // Step 0: Check IndexedDB availability (fails in iOS Safari Private Mode)
                console.log('[DevicePairing] Step 0: Checking IndexedDB availability...');
                debugLog('Checking IndexedDB...');
                try {
                    const testDB = indexedDB.open('__idb_test__', 1);
                    await new Promise((resolve, reject) => {
                        testDB.onerror = () => reject(new Error('IndexedDB not available'));
                        testDB.onsuccess = () => {
                            testDB.result.close();
                            indexedDB.deleteDatabase('__idb_test__');
                            resolve();
                        };
                        // Timeout after 3 seconds
                        setTimeout(() => reject(new Error('IndexedDB timeout')), 3000);
                    });
                    console.log('[DevicePairing] ‚úÖ IndexedDB is available');
                    debugLog('IndexedDB: OK', 'success');
                } catch (idbError) {
                    console.error('[DevicePairing] ‚ùå IndexedDB check failed:', idbError);
                    debugLog(`IndexedDB: FAILED - ${idbError.message}`, 'error');
                    throw new Error(
                        'IndexedDB is not available. ' +
                        (isMobile ? 'If you are using Private/Incognito mode, please switch to normal browsing mode. ' : '') +
                        'Device pairing requires local storage to work.'
                    );
                }

                // Step 0.5: Check Web Crypto API availability
                console.log('[DevicePairing] Step 0.5: Checking Web Crypto API...');
                debugLog('Checking Web Crypto API...');
                if (!window.crypto || !window.crypto.subtle) {
                    debugLog('Web Crypto: FAILED - not available', 'error');
                    throw new Error(
                        'Web Crypto API is not available. ' +
                        'Please ensure you are using HTTPS and a modern browser.'
                    );
                }
                console.log('[DevicePairing] ‚úÖ Web Crypto API is available');
                debugLog('Web Crypto: OK', 'success');

                // Initialize services
                console.log('[DevicePairing] Step 1/6: Initializing AuthService...');
                debugLog('Init AuthService...');
                await window.AuthService.initialize();
                console.log('[DevicePairing] ‚úÖ AuthService initialized');
                debugLog('AuthService: OK', 'success');

                console.log('[DevicePairing] Step 2/6: Initializing DatabaseService...');
                debugLog('Init DatabaseService...');
                await window.DatabaseService.initialize();
                console.log('[DevicePairing] ‚úÖ DatabaseService initialized');
                debugLog('DatabaseService: OK', 'success');

                // Prepare config with services before any encryption initialization
                MoneyTrackerEncryptionConfig.prepareWithServices();
                console.log('[DevicePairing] ‚úÖ Config prepared with services');

                console.log('[DevicePairing] Step 3/6: Initializing Encryption Module...');
                debugLog('Init Encryption Module (loading TweetNaCl from CDN)...');
                await window.CryptoLibraryLoader.load();
                await window.CryptoPrimitivesService.initialize();
                console.log('[DevicePairing] ‚úÖ CryptoPrimitivesService initialized');
                debugLog('CryptoPrimitivesService: OK', 'success');

                console.log('[DevicePairing] Step 4/6: Initializing KeyStorageService...');
                debugLog('Init KeyStorageService (opening IndexedDB)...');
                await window.KeyStorageService.initialize(MoneyTrackerEncryptionConfig);
                console.log('[DevicePairing] ‚úÖ KeyStorageService initialized');
                debugLog('KeyStorageService: OK', 'success');

                console.log('[DevicePairing] Step 5/6: Checking user authentication...');
                debugLog('Checking user authentication...');

                // Wait for session validation to complete (session check runs in background during init)
                console.log('[DevicePairing] Validating session...');
                const sessionValidation = await window.AuthService.validateSession();
                console.log('[DevicePairing] Session validation result:', sessionValidation);

                const currentUser = window.AuthService.getCurrentUser();
                console.log('[DevicePairing]   - User authenticated:', !!currentUser);
                if (currentUser) {
                    console.log('[DevicePairing]   - User ID:', currentUser.id);
                    console.log('[DevicePairing]   - User email:', currentUser.email);
                    debugLog(`User: ${currentUser.email}`, 'success');
                    debugLog(`User ID: ${currentUser.id.substring(0, 8)}...`);
                }

                if (!currentUser) {
                    console.error('[DevicePairing] ‚ùå No authenticated user found');
                    debugLog('Auth: FAILED - not logged in', 'error');
                    window.location.href = '../../auth/views/auth.html';
                    return;
                }
                console.log('[DevicePairing] ‚úÖ User authentication verified');

                console.log('[DevicePairing] Step 6/6: Initializing KeyManagementService...');
                debugLog('Init KeyManagementService...');
                const initResult = await window.KeyManagementService.initialize(currentUser.id, MoneyTrackerEncryptionConfig);
                console.log('[DevicePairing] KeyManagementService.initialize() result:', initResult);

                if (initResult.success && initResult.keysExist !== false) {
                    console.log('[DevicePairing] ‚úÖ KeyManagementService initialized with existing keys');
                    debugLog('KeyManagementService: OK (has keys)', 'success');
                } else if (initResult.needsRestore) {
                    // Keys exist in database but not locally - this is expected for secondary devices
                    console.log('[DevicePairing] ‚ö†Ô∏è Keys exist in database but not locally - restoration required');
                    console.log('[DevicePairing] This is normal for secondary devices');
                    debugLog('KeyManagementService: needs restore (no local keys)', 'warn');
                    console.log('[DevicePairing] ‚úÖ KeyManagementService configured for restore operations');
                } else if (initResult.success && initResult.keysExist === false) {
                    // No keys anywhere - this is a new user
                    console.log('[DevicePairing] ‚ÑπÔ∏è No keys found - this appears to be a new user');
                    debugLog('KeyManagementService: no keys (new user)', 'warn');
                } else if (!initResult.success && initResult.keyMismatch) {
                    // This device has different keys than database - clear and re-pair
                    console.log('[DevicePairing] ‚ö†Ô∏è Identity key mismatch detected!');
                    console.log('[DevicePairing] This device has different keys than the primary device');
                    console.log('[DevicePairing] Clearing local keys to allow fresh pairing...');
                    debugLog('KeyManagementService: KEY MISMATCH detected!', 'error');
                    debugLog('Clearing stale local keys...', 'warn');

                    // Clear local keys so user can do a fresh pairing
                    await window.KeyStorageService.clearAll();
                    console.log('[DevicePairing] ‚úÖ Local keys cleared');
                    debugLog('Local keys cleared, ready for fresh pairing', 'success');

                    // Show a helpful message
                    const statusMessage = document.createElement('div');
                    statusMessage.className = 'pairing-status info';
                    statusMessage.innerHTML = '<strong>Note:</strong> This device had different encryption keys. ' +
                        'They have been cleared. Please use one of the methods below to sync your keys from your primary device.';
                    const pairingHeader = document.querySelector('.pairing-header');
                    if (pairingHeader) {
                        pairingHeader.appendChild(statusMessage);
                    }

                    console.log('[DevicePairing] ‚úÖ Ready for fresh device pairing');
                } else if (!initResult.success) {
                    throw new Error(initResult.error || 'KeyManagementService initialization failed');
                }

                console.log('[DevicePairing] üéâ All services initialized successfully');
                console.log('[DevicePairing] Setting up event listeners...');
                setupEventListeners();
                console.log('[DevicePairing] ‚úÖ Event listeners configured');

                // CRITICAL: Check if user already has a backup in the database
                // If so, they MUST restore - generating new keys would break multi-device sync
                console.log('[DevicePairing] Checking for existing key backup...');
                debugLog('Checking for existing backup...');
                const hasExistingBackup = await window.KeyBackupService.hasBackup(currentUser.id);
                console.log('[DevicePairing] Has existing backup:', hasExistingBackup);
                debugLog(`Has backup: ${hasExistingBackup}`, hasExistingBackup ? 'warn' : 'info');

                if (hasExistingBackup) {
                    console.log('[DevicePairing] ‚ö†Ô∏è EXISTING BACKUP FOUND - User must restore, not generate new keys');
                    debugLog('BACKUP EXISTS - must restore!', 'warn');

                    // Show notice that backup exists
                    const backupNotice = document.getElementById('backup-exists-notice');
                    if (backupNotice) {
                        backupNotice.style.display = 'block';
                    }

                    // Hide "Setup New Device" button - only allow restore
                    const newDeviceBtn = document.getElementById('new-device-btn');
                    if (newDeviceBtn) {
                        newDeviceBtn.style.display = 'none';
                    }

                    // Rename the existing device button to be clearer
                    const existingDeviceBtn = document.getElementById('existing-device-btn');
                    if (existingDeviceBtn) {
                        existingDeviceBtn.innerHTML = '<i class="fas fa-key"></i> Restore My Keys';
                        existingDeviceBtn.classList.remove('btn-secondary');
                        existingDeviceBtn.classList.add('btn-primary');
                    }

                    // Update instruction text
                    const instructionText = document.querySelector('#choose-action-view .instruction-text p');
                    if (instructionText) {
                        instructionText.innerHTML = '<strong>Restore your encryption keys to access your messages</strong>';
                    }
                }

                console.log('[DevicePairing] Device pairing page is ready for user interaction');
                debugLog('=== INIT COMPLETE ===', 'success');
                debugLog('Ready for user action');

            } catch (error) {
                console.error('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                console.error('[DevicePairing] ‚ùå‚ùå‚ùå INITIALIZATION ERROR');
                console.error('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                console.error('[DevicePairing] Error name:', error.name);
                console.error('[DevicePairing] Error message:', error.message);
                console.error('[DevicePairing] Error stack:', error.stack);
                console.error('[DevicePairing] Full error object:', error);
                console.error('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');

                // Log to debug panel
                debugLog('=== INIT FAILED ===', 'error');
                debugLog(`Error: ${error.message}`, 'error');

                // Show error in UI (more visible on mobile than alert)
                const pairingCard = document.querySelector('.pairing-card');
                if (pairingCard) {
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'pairing-status error';
                    errorDiv.style.marginBottom = 'var(--spacing-lg)';
                    errorDiv.innerHTML = `
                        <strong>Initialization Error</strong><br>
                        ${error.message}<br><br>
                        <small>Please try refreshing the page. If the problem persists, try using a different browser or disabling private/incognito mode.</small>
                    `;
                    pairingCard.insertBefore(errorDiv, pairingCard.firstChild);
                }
                alert('Error initializing: ' + error.message);
            }
        }

        function setupEventListeners() {
            // Main action buttons
            document.getElementById('new-device-btn').addEventListener('click', () => {
                showView('choose-backup-method-view');
            });

            document.getElementById('existing-device-btn').addEventListener('click', () => {
                showView('choose-restore-method-view');
            });

            // Reset keys button
            document.getElementById('reset-keys-btn').addEventListener('click', async () => {
                await resetLocalKeys();
            });

            // Backup method selection
            document.getElementById('qr-backup-method').addEventListener('click', async () => {
                await generateQRCode();
            });

            document.getElementById('password-backup-method').addEventListener('click', () => {
                showView('password-backup-view');
            });

            // Restore method selection
            document.getElementById('qr-restore-method').addEventListener('click', () => {
                startQRScanner();
            });

            document.getElementById('password-restore-method').addEventListener('click', () => {
                showView('password-restore-view');
            });

            document.getElementById('recovery-key-restore-method').addEventListener('click', () => {
                showView('recovery-key-restore-view');
            });

            // Recovery key input validation
            document.getElementById('recovery-key-input').addEventListener('input', (e) => {
                const text = e.target.value.trim();
                const words = text ? text.split(/\s+/).filter(w => w.length > 0) : [];
                const wordCount = words.length;

                const countEl = document.getElementById('recovery-key-word-count');
                const restoreBtn = document.getElementById('restore-recovery-key-btn');

                countEl.textContent = `${wordCount} / 24 words`;

                if (wordCount === 24) {
                    countEl.style.color = 'var(--success-color)';
                    restoreBtn.disabled = false;
                } else {
                    countEl.style.color = 'var(--text-color-secondary)';
                    restoreBtn.disabled = true;
                }
            });

            // Password backup
            document.getElementById('backup-password').addEventListener('input', (e) => {
                const indicator = document.getElementById('password-strength-indicator');
                indicator.innerHTML = checkPasswordStrength(e.target.value);
            });

            document.getElementById('create-backup-btn').addEventListener('click', async () => {
                await createPasswordBackup();
            });

            document.getElementById('restore-backup-btn').addEventListener('click', async () => {
                await restoreFromPassword();
            });

            document.getElementById('restore-recovery-key-btn').addEventListener('click', async () => {
                await restoreFromRecoveryKey();
            });

            // Back buttons
            document.getElementById('back-to-action-btn').addEventListener('click', () => showView('choose-action-view'));
            document.getElementById('back-to-action-btn-2').addEventListener('click', () => showView('choose-action-view'));
            document.getElementById('back-from-qr-gen-btn').addEventListener('click', () => showView('choose-backup-method-view'));
            document.getElementById('back-from-qr-scan-btn').addEventListener('click', () => {
                if (qrScanner) qrScanner.stop();
                showView('choose-restore-method-view');
            });
            document.getElementById('back-from-backup-btn').addEventListener('click', () => showView('choose-backup-method-view'));
            document.getElementById('back-from-restore-btn').addEventListener('click', () => showView('choose-restore-method-view'));
            document.getElementById('back-from-recovery-restore-btn').addEventListener('click', () => showView('choose-restore-method-view'));
            document.getElementById('done-qr-btn').addEventListener('click', () => {
                window.location.href = '../../landing/index.html';
            });
        }

        async function generateQRCode() {
            try {
                // CRITICAL SAFETY CHECK: Prevent generating new keys if backup already exists
                const currentUser = window.AuthService.getCurrentUser();
                if (currentUser) {
                    const hasExistingBackup = await window.KeyBackupService.hasBackup(currentUser.id);
                    if (hasExistingBackup) {
                        console.error('[DevicePairing] ‚ùå BLOCKED: Cannot generate QR - backup already exists!');
                        alert('You already have encryption keys. Please use "Restore from Another Device" instead.');
                        showView('choose-action-view');
                        return;
                    }
                }

                const statusEl = document.querySelector('#qr-generation-view .pairing-status');
                statusEl.textContent = 'Generating QR code...';
                statusEl.className = 'pairing-status info';

                const qrData = await window.KeyManagementService.generateQRCodeForPairing();

                const qr = new QRious({
                    element: document.getElementById('qr-canvas'),
                    value: qrData,
                    size: 300,
                    level: 'H'
                });

                showView('qr-generation-view');
                statusEl.textContent = '';
                statusEl.className = 'pairing-status';

            } catch (error) {
                console.error('[DevicePairing] QR generation error:', error);
                alert('Failed to generate QR code: ' + error.message);
            }
        }

        function startQRScanner() {
            showView('qr-scanning-view');

            const statusEl = document.getElementById('qr-scan-status');
            statusEl.textContent = 'Initializing camera...';
            statusEl.className = 'pairing-status info';

            qrScanner = new Html5Qrcode("qr-reader");

            qrScanner.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: 250 },
                async (decodedText) => {
                    statusEl.textContent = 'QR code detected! Restoring keys...';
                    statusEl.className = 'pairing-status info';

                    try {
                        await qrScanner.stop();
                        await window.KeyManagementService.restoreFromQRCode(decodedText);

                        statusEl.textContent = '‚úì Keys restored successfully!';
                        statusEl.className = 'pairing-status success';

                        setTimeout(() => {
                            window.location.href = '../../landing/index.html';
                        }, 2000);

                    } catch (error) {
                        console.error('[DevicePairing] QR restore error:', error);
                        statusEl.textContent = '‚úó Error: ' + error.message;
                        statusEl.className = 'pairing-status error';
                    }
                }
            ).then(() => {
                statusEl.textContent = 'Point camera at QR code';
                statusEl.className = 'pairing-status info';
            }).catch(err => {
                console.error('[DevicePairing] Camera error:', err);
                statusEl.textContent = '‚úó Camera access denied or unavailable';
                statusEl.className = 'pairing-status error';
            });
        }

        async function createPasswordBackup() {
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('[DevicePairing] üöÄ createPasswordBackup() STARTED');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');

            const password = document.getElementById('backup-password').value;
            const confirmPassword = document.getElementById('backup-password-confirm').value;
            const statusEl = document.getElementById('backup-status');

            // CRITICAL SAFETY CHECK: Prevent generating new keys if backup already exists
            // This prevents accidentally overwriting keys from another device
            const currentUser = window.AuthService.getCurrentUser();
            if (currentUser) {
                const hasExistingBackup = await window.KeyBackupService.hasBackup(currentUser.id);
                if (hasExistingBackup) {
                    console.error('[DevicePairing] ‚ùå BLOCKED: Cannot generate new keys - backup already exists!');
                    console.error('[DevicePairing] User must use "Restore from Another Device" instead');
                    statusEl.textContent = 'You already have encryption keys. Please use "Restore from Another Device" instead.';
                    statusEl.className = 'pairing-status error';
                    return;
                }
            }

            console.log('[DevicePairing] Step 0/6: Validating input');
            console.log('[DevicePairing]   - Password length:', password ? password.length : 0);
            console.log('[DevicePairing]   - Passwords match:', password === confirmPassword);

            if (!password || password.length < 8) {
                console.error('[DevicePairing] ‚ùå Validation failed: Password too short');
                statusEl.textContent = 'Password must be at least 8 characters';
                statusEl.className = 'pairing-status error';
                return;
            }

            if (password !== confirmPassword) {
                console.error('[DevicePairing] ‚ùå Validation failed: Passwords do not match');
                statusEl.textContent = 'Passwords do not match';
                statusEl.className = 'pairing-status error';
                return;
            }

            console.log('[DevicePairing] ‚úÖ Input validation passed');

            try {
                // Step 1: Verify services are available
                console.log('[DevicePairing] Step 1/6: Verifying required services');
                console.log('[DevicePairing]   - AuthService available:', !!window.AuthService);
                console.log('[DevicePairing]   - KeyStorageService available:', !!window.KeyStorageService);
                console.log('[DevicePairing]   - KeyManagementService available:', !!window.KeyManagementService);
                console.log('[DevicePairing]   - CryptoPrimitivesService available:', !!window.CryptoPrimitivesService);

                if (!window.AuthService) throw new Error('AuthService not available');
                if (!window.KeyStorageService) throw new Error('KeyStorageService not available');
                if (!window.KeyManagementService) throw new Error('KeyManagementService not available');
                if (!window.CryptoPrimitivesService) throw new Error('CryptoPrimitivesService not available');

                console.log('[DevicePairing] ‚úÖ All required services available');

                // Step 2: Get and verify current user
                statusEl.textContent = 'Step 1/5: Verifying authentication...';
                statusEl.className = 'pairing-status info';

                console.log('[DevicePairing] Step 2/6: Getting current user');
                const currentUser = window.AuthService.getCurrentUser();
                console.log('[DevicePairing]   - User authenticated:', !!currentUser);
                if (currentUser) {
                    console.log('[DevicePairing]   - User ID:', currentUser.id);
                    console.log('[DevicePairing]   - User email:', currentUser.email);
                }

                if (!currentUser) {
                    throw new Error('Not authenticated - please log in first');
                }
                console.log('[DevicePairing] ‚úÖ User authenticated successfully');

                // Step 3: Initialize KeyManagementService and check/generate identity keys
                statusEl.textContent = 'Step 2/5: Checking encryption keys...';

                console.log('[DevicePairing] Step 3/6: Initializing KeyManagementService...');

                // Initialize KeyManagementService with config (required before any key operations)
                const initResult = await window.KeyManagementService.initialize(currentUser.id, MoneyTrackerEncryptionConfig);
                console.log('[DevicePairing]   - Initialize result:', initResult);

                // Check for existing local keys
                const existingKeys = await window.KeyStorageService.getIdentityKeys(currentUser.id);
                console.log('[DevicePairing]   - Existing keys found:', !!existingKeys);
                if (existingKeys) {
                    console.log('[DevicePairing]   - Public key exists:', !!existingKeys.publicKey);
                    console.log('[DevicePairing]   - Secret key exists:', !!existingKeys.secretKey);
                }

                if (!existingKeys || !existingKeys.publicKey) {
                    console.log('[DevicePairing] üîë Generating new identity keys...');
                    statusEl.textContent = 'Step 2/5: Generating encryption keys...';
                    await window.KeyManagementService.generateAndStoreIdentityKeys(currentUser.id);
                    console.log('[DevicePairing] ‚úÖ Identity keys generated and stored');
                } else {
                    console.log('[DevicePairing] ‚úÖ Identity keys already exist, skipping generation');
                }

                // Step 4: Generate recovery key
                statusEl.textContent = 'Step 3/5: Generating recovery key...';

                console.log('[DevicePairing] Step 4/6: Generating recovery key');
                const recoveryKeyB64 = window.PasswordCryptoService.generateRecoveryKey();
                const recoveryKey = window.PasswordCryptoService.formatRecoveryKey(recoveryKeyB64);
                console.log('[DevicePairing]   - Recovery key generated:', !!recoveryKey);
                console.log('[DevicePairing]   - Recovery key length:', recoveryKey ? recoveryKey.length : 0);
                console.log('[DevicePairing]   - Recovery key format: Base32 with dashes');
                console.log('[DevicePairing]   - First segment:', recoveryKey ? recoveryKey.split('-').slice(0, 3).join('-') + '...' : 'N/A');
                console.log('[DevicePairing] ‚úÖ Recovery key generated');

                // Step 5: Show recovery key to user
                console.log('[DevicePairing] Step 5/6: Showing recovery key to user for confirmation');
                statusEl.textContent = 'Step 4/5: Please save your recovery key...';

                const confirmed = confirm(
                    `IMPORTANT: Save this recovery key!\n\n${recoveryKey}\n\n` +
                    `This is the ONLY way to recover your data if you forget your password.\n\n` +
                    `Write it down and store it in a safe place.\n\n` +
                    `Click OK after you've saved it.`
                );

                console.log('[DevicePairing]   - User confirmed recovery key:', confirmed);

                if (!confirmed) {
                    console.warn('[DevicePairing] ‚ö†Ô∏è User cancelled setup - did not confirm recovery key');
                    statusEl.textContent = 'Setup cancelled - recovery key not confirmed';
                    statusEl.className = 'pairing-status error';
                    return;
                }
                console.log('[DevicePairing] ‚úÖ User confirmed recovery key');

                // Step 6: Create dual backup
                // Warn user that this may take a while on mobile
                const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
                if (isMobile) {
                    statusEl.innerHTML = 'Step 5/5: Creating encrypted backups...<br><small>(This may take 15-30 seconds on mobile)</small>';
                } else {
                    statusEl.textContent = 'Step 5/5: Creating encrypted backups...';
                }

                console.log('[DevicePairing] Step 6/6: Creating dual backup');
                console.log('[DevicePairing]   - Password length:', password.length);
                console.log('[DevicePairing]   - Recovery key segment count:', recoveryKey.split('-').length);
                console.log('[DevicePairing]   - Device type:', isMobile ? 'Mobile' : 'Desktop');
                console.log('[DevicePairing]   - Calling KeyManagementService.createDualBackup()...');

                // Pass the base64 version to createDualBackup for cryptographic operations
                await window.KeyManagementService.createDualBackup(password, recoveryKeyB64);

                console.log('[DevicePairing] ‚úÖ Dual backup created successfully!');
                console.log('[DevicePairing] üéâ Device pairing setup COMPLETE');

                statusEl.textContent = '‚úì Backup created successfully!';
                statusEl.className = 'pairing-status success';

                console.log('[DevicePairing] Redirecting to landing page in 2 seconds...');
                setTimeout(() => {
                    window.location.href = '../../landing/index.html';
                }, 2000);

            } catch (error) {
                console.error('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                console.error('[DevicePairing] ‚ùå‚ùå‚ùå CRITICAL ERROR IN createPasswordBackup()');
                console.error('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                console.error('[DevicePairing] Error name:', error.name);
                console.error('[DevicePairing] Error message:', error.message);
                console.error('[DevicePairing] Error stack:', error.stack);
                console.error('[DevicePairing] Full error object:', error);
                console.error('[DevicePairing] Error toString:', error.toString());
                console.error('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');

                statusEl.textContent = '‚úó Error: ' + error.message;
                statusEl.className = 'pairing-status error';

                // Also show alert so user definitely sees the error
                alert(`Setup Error:\n\n${error.message}\n\nCheck the browser console for detailed logs.`);
            }
        }

        async function restoreFromPassword() {
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('[DevicePairing] üîÑ restoreFromPassword() STARTED');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');

            const password = document.getElementById('restore-password').value;
            const statusEl = document.getElementById('restore-status');

            console.log('[DevicePairing] Step 1/3: Validating password input');
            console.log('[DevicePairing]   - Password provided:', !!password);
            console.log('[DevicePairing]   - Password length:', password ? password.length : 0);

            if (!password) {
                console.error('[DevicePairing] ‚ùå Validation failed: No password provided');
                statusEl.textContent = 'Please enter your password';
                statusEl.className = 'pairing-status error';
                return;
            }

            console.log('[DevicePairing] ‚úÖ Password validation passed');

            try {
                console.log('[DevicePairing] Step 2/3: Verifying KeyManagementService');
                console.log('[DevicePairing]   - KeyManagementService available:', !!window.KeyManagementService);
                console.log('[DevicePairing]   - restoreFromPassword function exists:',
                    !!(window.KeyManagementService && window.KeyManagementService.restoreFromPassword));

                if (!window.KeyManagementService) {
                    throw new Error('KeyManagementService not available');
                }

                // Warn user that this may take a while on mobile
                const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
                if (isMobile) {
                    statusEl.innerHTML = 'Restoring keys from backup...<br><small>(This may take 15-30 seconds on mobile)</small>';
                } else {
                    statusEl.textContent = 'Restoring keys from backup...';
                }
                statusEl.className = 'pairing-status info';

                console.log('[DevicePairing] Step 3/3: Calling KeyManagementService.restoreFromPassword()');
                console.log('[DevicePairing] Device type:', isMobile ? 'Mobile' : 'Desktop');
                debugLog('Calling restoreFromPassword...');
                debugLog('(PBKDF2 600k iterations - may take 15-30s on mobile)', 'warn');
                const startTime = Date.now();
                await window.KeyManagementService.restoreFromPassword(password);
                const duration = ((Date.now() - startTime) / 1000).toFixed(1);
                console.log('[DevicePairing] ‚úÖ Password backup restore successful!');
                debugLog(`Restore SUCCESS in ${duration}s`, 'success');

                statusEl.textContent = '‚úì Keys restored successfully!';
                statusEl.className = 'pairing-status success';

                console.log('[DevicePairing] Redirecting to landing page in 2 seconds...');
                debugLog('Redirecting in 2s...');
                setTimeout(() => {
                    window.location.href = '../../landing/index.html';
                }, 2000);

            } catch (error) {
                console.error('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                console.error('[DevicePairing] ‚ùå‚ùå‚ùå CRITICAL ERROR IN restoreFromPassword()');
                console.error('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                console.error('[DevicePairing] Error name:', error.name);
                console.error('[DevicePairing] Error message:', error.message);
                console.error('[DevicePairing] Error stack:', error.stack);
                console.error('[DevicePairing] Full error object:', error);
                console.error('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');

                debugLog(`Restore FAILED: ${error.message}`, 'error');

                statusEl.textContent = '‚úó Error: ' + error.message;
                statusEl.className = 'pairing-status error';

                alert(`Restore Error:\n\n${error.message}\n\nCheck the browser console for detailed logs.`);
            }
        }

        async function restoreFromRecoveryKey() {
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('[DevicePairing] üîë restoreFromRecoveryKey() STARTED');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');

            const recoveryKeyText = document.getElementById('recovery-key-input').value.trim();
            const statusEl = document.getElementById('recovery-restore-status');

            console.log('[DevicePairing] Step 1/3: Validating recovery key input');
            console.log('[DevicePairing]   - Recovery key provided:', !!recoveryKeyText);
            console.log('[DevicePairing]   - Recovery key length:', recoveryKeyText.length);

            // Validate word count
            const words = recoveryKeyText.split(/\s+/).filter(w => w.length > 0);
            console.log('[DevicePairing]   - Word count:', words.length);
            console.log('[DevicePairing]   - First 3 words:', words.slice(0, 3).join(' ') + '...');
            console.log('[DevicePairing]   - Last 3 words:', '...' + words.slice(-3).join(' '));

            if (words.length !== 24) {
                console.error('[DevicePairing] ‚ùå Validation failed: Expected 24 words, got', words.length);
                statusEl.textContent = `Please enter exactly 24 words (you have ${words.length})`;
                statusEl.className = 'pairing-status error';
                return;
            }

            console.log('[DevicePairing] ‚úÖ Recovery key validation passed (24 words confirmed)');

            try {
                console.log('[DevicePairing] Step 2/3: Verifying KeyManagementService');
                console.log('[DevicePairing]   - KeyManagementService available:', !!window.KeyManagementService);
                console.log('[DevicePairing]   - restoreFromRecoveryKeyBackup function exists:',
                    !!(window.KeyManagementService && window.KeyManagementService.restoreFromRecoveryKeyBackup));

                if (!window.KeyManagementService) {
                    throw new Error('KeyManagementService not available');
                }

                // Warn user that this may take a while on mobile
                const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
                if (isMobile) {
                    statusEl.innerHTML = 'Restoring keys from recovery key...<br><small>(This may take 15-30 seconds on mobile)</small>';
                } else {
                    statusEl.textContent = 'Restoring keys from recovery key...';
                }
                statusEl.className = 'pairing-status info';

                console.log('[DevicePairing] Step 3/3: Calling KeyManagementService.restoreFromRecoveryKeyBackup()');
                console.log('[DevicePairing]   - Recovery key word count:', words.length);
                console.log('[DevicePairing] Device type:', isMobile ? 'Mobile' : 'Desktop');
                await window.KeyManagementService.restoreFromRecoveryKeyBackup(recoveryKeyText);
                console.log('[DevicePairing] ‚úÖ Recovery key backup restore successful!');

                statusEl.textContent = '‚úì Keys restored successfully with recovery key!';
                statusEl.className = 'pairing-status success';

                console.log('[DevicePairing] Redirecting to landing page in 2 seconds...');
                setTimeout(() => {
                    window.location.href = '../../landing/index.html';
                }, 2000);

            } catch (error) {
                console.error('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                console.error('[DevicePairing] ‚ùå‚ùå‚ùå CRITICAL ERROR IN restoreFromRecoveryKey()');
                console.error('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                console.error('[DevicePairing] Error name:', error.name);
                console.error('[DevicePairing] Error message:', error.message);
                console.error('[DevicePairing] Error stack:', error.stack);
                console.error('[DevicePairing] Full error object:', error);
                console.error('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');

                statusEl.textContent = '‚úó Error: ' + error.message;
                statusEl.className = 'pairing-status error';

                alert(`Recovery Key Restore Error:\n\n${error.message}\n\nCheck the browser console for detailed logs.`);
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>
