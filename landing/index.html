<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Money Tracker - Home</title>
    <link rel="stylesheet" href="../shared/vendor/font-awesome/css/all.min.css">
    <link rel="stylesheet" href="../shared/styles/main-compiled.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script>
        (function() {
            var m = { 'very-small': 13, small: 14, medium: 16, large: 18, 'very-large': 20 };
            var s = localStorage.getItem('money_tracker_fontScale') || 'medium';
            document.documentElement.style.fontSize = (m[s] || 16) + 'px';
        })();
    </script>
</head>
<body class="page-container">
    <!-- Header injected by Header.js -->

    <main class="main-content landing-main-content" role="main">
        <!-- Two Column Layout: Savings + Table | Pie Chart -->
        <section class="overview-two-column">
            <!-- Left Column: Savings Banner + Savings Table -->
            <div class="overview-left-column">
                <!-- Prominent Total Savings -->
                <div class="savings-highlight" id="total-savings-highlight">
                    <div class="savings-label">Total Savings</div>
                    <div class="savings-amount" id="total-savings-display">0.00</div>
                </div>

                <!-- Monthly Savings Table -->
                <div class="savings-table-container">
                    <h3 class="savings-table-title savings-table-title-clickable" id="savings-table-title">Savings by Month</h3>
                    <div class="savings-table-wrapper">
                        <table class="savings-table" id="savings-by-month-table">
                            <thead>
                                <tr>
                                    <th>Month</th>
                                    <th>Estimate</th>
                                    <th>Actual</th>
                                </tr>
                            </thead>
                            <tbody id="savings-by-month-tbody">
                                <tr>
                                    <td colspan="3" class="text-center text-muted">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Right Column: Pie Chart -->
            <div class="overview-right-column">
                <div class="expense-chart-section" id="expense-breakdown-section">
                    <h2 class="section-title">Expense Breakdown</h2>
                    <div class="chart-container">
                        <div class="pie-chart-wrapper">
                            <svg viewBox="0 0 100 100" id="expense-pie-chart">
                                <circle cx="50" cy="50" r="40" fill="var(--color-bg-surface)" />
                            </svg>
                        </div>
                        <div class="chart-legend" id="expense-legend">
                            <div class="legend-item">
                                <span class="legend-color" style="background: var(--color-action)"></span>
                                <span class="legend-label">Loading...</span>
                            </div>
                        </div>
                    </div>
                    <label class="all-months-toggle">
                        <input type="checkbox" id="all-months-checkbox">
                        <span>All months</span>
                    </label>
                </div>
            </div>
        </section>

        <!-- Expenses Calendar Section -->
        <section class="section" aria-labelledby="expenses-calendar-heading">
            <div class="calendar-container" id="expenses-calendar-container">
                <div class="calendar-header">
                    <a href="#" class="calendar-month-year-link" id="calendar-month-link" title="View this month's budget">
                        <span class="calendar-month-year" id="calendar-month-year">Loading...</span>
                    </a>
                </div>
                <div class="calendar-weekdays">
                    <div class="calendar-weekday">Mon</div>
                    <div class="calendar-weekday">Tue</div>
                    <div class="calendar-weekday">Wed</div>
                    <div class="calendar-weekday">Thu</div>
                    <div class="calendar-weekday">Fri</div>
                    <div class="calendar-weekday">Sat</div>
                    <div class="calendar-weekday">Sun</div>
                </div>
                <div class="calendar-grid" id="calendar-grid">
                    <div class="text-center text-muted py-8" style="grid-column: 1 / -1;">
                        Loading calendar...
                    </div>
                </div>
            </div>
        </section>

        <!-- Monthly Comparison Cards -->
        <section class="section" aria-labelledby="months-comparison-heading">
            <div class="section-header-with-action">
                <h2 id="months-comparison-heading" class="section-title">Monthly Overview</h2>
                <button class="add-month-button" id="add-new-month-button" aria-label="Create new month" title="Create new month">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
            <div class="month-cards-grid" id="month-cards-container">
                <div class="text-center text-muted py-8">
                    <div class="spinner mx-auto mb-2"></div>
                    Loading data...
                </div>
            </div>
        </section>
    </main>

    <!-- Calendar Day Popup -->
    <div class="calendar-popup" id="calendar-popup">
        <div class="calendar-popup-header">
            <span class="calendar-popup-date" id="popup-date"></span>
            <button class="calendar-popup-close" id="popup-close" aria-label="Close popup">&times;</button>
        </div>
        <div class="calendar-popup-content" id="popup-content">
            <!-- Expense details rendered here -->
        </div>
    </div>
    <div class="calendar-popup-overlay" id="popup-overlay"></div>

    <!-- Create Month Modal -->
    <div class="modal" id="create-month-modal">
        <div class="modal-overlay" id="create-month-overlay"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Create New Month</h3>
            </div>
            <form id="create-month-form" class="modal-body">
                <div class="form-group">
                    <label for="new-month-year">Year</label>
                    <input type="number" id="new-month-year" name="year" min="2000" max="2100" required class="form-input">
                </div>
                <div class="form-group">
                    <label for="new-month-month">Month</label>
                    <select id="new-month-month" name="month" required class="form-input">
                        <option value="1">January</option>
                        <option value="2">February</option>
                        <option value="3">March</option>
                        <option value="4">April</option>
                        <option value="5">May</option>
                        <option value="6">June</option>
                        <option value="7">July</option>
                        <option value="8">August</option>
                        <option value="9">September</option>
                        <option value="10">October</option>
                        <option value="11">November</option>
                        <option value="12">December</option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="cancel-create-month">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Month</button>
                </div>
            </form>
        </div>
    </div>

    <!-- All Months Savings Modal -->
    <div class="modal" id="all-savings-modal">
        <div class="modal-overlay" id="all-savings-overlay"></div>
        <div class="modal-content modal-content-wide">
            <div class="modal-header">
                <h3 class="modal-title">Savings by Month</h3>
                <button type="button" class="modal-close" id="close-all-savings">&times;</button>
            </div>
            <div class="modal-body">
                <table class="savings-table savings-table-full">
                    <thead>
                        <tr>
                            <th>Month</th>
                            <th>Estimate</th>
                            <th>Actual</th>
                        </tr>
                    </thead>
                    <tbody id="all-savings-tbody">
                        <tr>
                            <td colspan="3" class="text-center text-muted">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Expense Breakdown Modal -->
    <div class="modal" id="expense-breakdown-modal">
        <div class="modal-overlay" id="expense-breakdown-overlay"></div>
        <div class="modal-content modal-content-wide">
            <div class="modal-header">
                <h3 class="modal-title">Expense Breakdown</h3>
                <button type="button" class="modal-close" id="close-expense-breakdown">&times;</button>
            </div>
            <div class="modal-body">
                <div class="expense-breakdown-total" id="expense-breakdown-total"></div>
                <table class="expense-breakdown-table">
                    <thead>
                        <tr>
                            <th>Category</th>
                            <th>Amount</th>
                            <th>Percentage</th>
                        </tr>
                    </thead>
                    <tbody id="expense-breakdown-tbody">
                        <tr>
                            <td colspan="3" class="text-center text-muted">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Global Logging Configuration -->
    <script src="../shared/config/loggingConfig.js"></script>
    <script src="../database/config/supabaseConfig.js"></script>
    <script src="../shared/services/authService.js"></script>

    <!-- Database Module -->
    <script src="../database/config/databaseConfigBase.js"></script>
    <script src="../database/config/moneyTrackerDatabaseConfig.js"></script>
    <script src="../database/utils/databaseConfigHelper.js"></script>
    <script src="../database/databaseModule.js"></script>

    <!-- Core Utilities -->
    <script src="../shared/config/moduleRegistry.js"></script>
    <script src="../shared/config/constants.js"></script>
    <script src="../shared/utils/logger.js"></script>
    <script src="../shared/utils/errorHandler.js"></script>
    <script src="../shared/utils/validators.js"></script>

    <!-- Database Services -->
    <script src="../database/services/databaseService.js"></script>
    <script src="../database/services/dataSharingService.js"></script>
    <script src="../database/services/fieldLockingService.js"></script>

    <!-- Notification Services -->
    <script src="../database/services/notificationTypeRegistry.js"></script>
    <script src="../database/services/notificationService.js"></script>
    <script src="../database/services/notificationPreferenceService.js"></script>
    <script src="../database/services/notificationChannelService.js"></script>
    <script src="../database/services/notificationProcessor.js"></script>

    <!-- Messaging Service -->
    <script src="../messaging/services/messagingService.js"></script>

    <!-- Initialize Database Module -->
    <script src="../database/initDatabase.js"></script>

    <!-- Payments Module -->
    <script src="../payments/config/paymentsConfigBase.js"></script>
    <script src="../payments/config/moneyTrackerConfig.js"></script>
    <script src="../payments/utils/configHelper.js"></script>
    <script src="../payments/paymentsModule.js"></script>
    <script src="../payments/services/stripeService.js"></script>
    <script src="../payments/services/paymentService.js"></script>
    <script src="../payments/services/subscriptionService.js"></script>
    <script src="../payments/utils/subscriptionChecker.js"></script>
    <script src="../payments/initPayments.js"></script>
    <script src="../payments/utils/waitForPaymentsInit.js"></script>
    <script src="../shared/utils/subscriptionGuard.js"></script>

    <!-- E2E Encryption Module -->
    <script src="../encryption/config/encryptionConfigBase.js"></script>
    <script src="../encryption/config/moneyTrackerEncryptionConfig.js"></script>
    <script src="../encryption/utils/encryptionConfigHelper.js"></script>
    <script src="../encryption/services/cryptoLibraryLoader.js"></script>
    <script src="../encryption/services/keyDerivationService.js"></script>
    <script src="../encryption/services/cryptoPrimitivesService.js"></script>
    <script src="../encryption/services/keyStorageService.js"></script>
    <script src="../encryption/services/historicalKeysService.js"></script>
    <script src="../encryption/services/passwordCryptoService.js"></script>
    <script src="../encryption/services/keyBackupService.js"></script>
    <script src="../encryption/services/keyManagementService.js"></script>
    <script src="../encryption/facade/encryptionFacade.js"></script>
    <script src="../encryption/facade/nullEncryptionFacade.js"></script>
    <script src="../encryption/encryptionModule.js"></script>
    <script src="../encryption/initEncryption.js"></script>

    <!-- Guards and Utilities -->
    <script src="../shared/utils/pairing-guard.js"></script>
    <script src="../shared/utils/permissionService.js"></script>
    <script src="../shared/utils/authGuard.js"></script>
    <script src="../shared/utils/networkUtils.js"></script>
    <script src="../shared/utils/offlineHandler.js"></script>
    <script src="../database/models/dataManager.js"></script>
    <script src="../database/models/monthFactory.js"></script>
    <script src="../shared/services/calculationService.js"></script>
    <script src="../shared/services/formHandler.js"></script>
    <script src="../shared/services/tableRenderer.js"></script>
    <script src="../shared/utils/formatters.js"></script>
    <script src="../shared/services/fileService.js"></script>
    <script src="../shared/services/exportService.js"></script>
    <script src="../shared/header/header.js"></script>
    <script src="utils/initialData.js"></script>

    <script>
        console.log('[Landing] Script initialization starting...');

        document.addEventListener('DOMContentLoaded', async function() {
            try {
                console.log('[Landing] Starting initialization...');

                if (window.CryptoLibraryLoader && typeof window.CryptoLibraryLoader.load === 'function') {
                    await window.CryptoLibraryLoader.load();
                    await window.CryptoPrimitivesService.initialize();
                    console.log('[Landing] Encryption module initialized');
                }

                const [paymentsReady, dbInitResult] = await Promise.all([
                    window.waitForPaymentsInit ? window.waitForPaymentsInit() : Promise.resolve(),
                    window.DatabaseService.initialize()
                ]);
                console.log('[Landing] Payments and Database initialized');

                const isAuthenticated = await window.AuthGuard.checkAuth();
                if (!isAuthenticated) {
                    console.log('[Landing] Not authenticated, redirecting...');
                    return;
                }
                console.log('[Landing] Authentication check passed');

                if (window.PairingGuard) {
                    console.log('[Landing] Checking device pairing status...');
                    const isPaired = await window.PairingGuard.requirePairing();
                    if (!isPaired) {
                        return; // requirePairing signs out if not paired
                    }
                    console.log('[Landing] Device pairing check passed');
                }

                await DataManager.initializeSettings();
                await DataManager.applyFontScale();
                console.log('[Landing] Settings initialized');

                await InitialData.initializeIfEmpty();
                console.log('[Landing] Initial data checked');

                window.landingControllerInitialized = true;

                if (window.LandingController) {
                    await window.LandingController.init();
                    console.log('[Landing] LandingController initialized');
                }

                console.log('[Landing] Initialization complete!');
            } catch (error) {
                console.error('[Landing] Initialization error:', error);
                const tbody = document.getElementById('months-comparison-tbody');
                if (tbody) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="9" class="text-center py-8 text-danger">
                                <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                                <p>Failed to load data. Please refresh the page.</p>
                            </td>
                        </tr>
                    `;
                }
            }
        });
    </script>
    <script src="controllers/landingController.js"></script>
</body>
</html>
