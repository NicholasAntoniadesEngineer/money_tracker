<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Money Tracker - Home</title>
    <link rel="stylesheet" href="../shared/vendor/font-awesome/css/all.min.css">
    <link rel="stylesheet" href="../shared/styles/main-compiled.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script>
        (function() {
            console.log('[Landing] Font size initialization...');
            const cachedFontSize = localStorage.getItem('money_tracker_fontSize');
            document.documentElement.style.fontSize = (cachedFontSize || '16') + 'px';

            async function syncFontSizeFromDatabase() {
                try {
                    if (window.DatabaseService && window.AuthService && window.AuthService.isAuthenticated()) {
                        const settings = await window.DatabaseService.getSettings();
                        if (settings && settings.fontSize) {
                            document.documentElement.style.fontSize = settings.fontSize + 'px';
                            localStorage.setItem('money_tracker_fontSize', settings.fontSize);
                        }
                    } else if (document.readyState !== 'complete') {
                        setTimeout(syncFontSizeFromDatabase, 100);
                    }
                } catch (error) {
                    console.log('[Landing] Font size sync silently failed');
                }
            }
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', syncFontSizeFromDatabase);
            } else {
                syncFontSizeFromDatabase();
            }
        })();
    </script>
</head>
<body class="page-container">
    <!-- Header injected by Header.js -->

    <main class="main-content" role="main">
        <!-- Hero Section -->
        <section class="hero-section rounded-lg">
            <h2 class="hero-title">Financial Overview</h2>
        </section>

        <!-- Two Column Layout: Savings + Table | Pie Chart -->
        <section class="overview-two-column">
            <!-- Left Column: Savings Banner + Savings Table -->
            <div class="overview-left-column">
                <!-- Prominent Total Savings -->
                <div class="savings-highlight" id="total-savings-highlight">
                    <div class="savings-label">Total Savings</div>
                    <div class="savings-amount" id="total-savings-display">0.00</div>
                </div>

                <!-- Monthly Savings Table -->
                <div class="savings-table-container">
                    <h3 class="savings-table-title">Savings by Month</h3>
                    <table class="savings-table" id="savings-by-month-table">
                        <thead>
                            <tr>
                                <th>Month</th>
                                <th>Estimate</th>
                                <th>Actual</th>
                            </tr>
                        </thead>
                        <tbody id="savings-by-month-tbody">
                            <tr>
                                <td colspan="3" class="text-center text-muted">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Right Column: Pie Chart -->
            <div class="overview-right-column">
                <div class="expense-chart-section" id="expense-breakdown-section">
                    <h2 class="section-title">Expense Breakdown</h2>
                    <div class="chart-container">
                        <div class="pie-chart-wrapper">
                            <svg viewBox="0 0 100 100" id="expense-pie-chart">
                                <circle cx="50" cy="50" r="40" fill="var(--color-bg-surface)" />
                            </svg>
                        </div>
                        <div class="chart-legend" id="expense-legend">
                            <div class="legend-item">
                                <span class="legend-color" style="background: var(--color-action)"></span>
                                <span class="legend-label">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Monthly Comparison Cards -->
        <section class="section" aria-labelledby="months-comparison-heading">
            <h2 id="months-comparison-heading" class="section-title">Monthly Overview</h2>
            <div class="month-cards-grid" id="month-cards-container">
                <div class="text-center text-muted py-8">
                    <div class="spinner mx-auto mb-2"></div>
                    Loading data...
                </div>
            </div>
        </section>
    </main>


    <!-- Global Logging Configuration -->
    <script src="../shared/config/loggingConfig.js"></script>
    <script src="../database/config/supabaseConfig.js"></script>
    <script src="../shared/services/authService.js"></script>

    <!-- Database Module -->
    <script src="../database/config/databaseConfigBase.js"></script>
    <script src="../database/config/moneyTrackerDatabaseConfig.js"></script>
    <script src="../database/utils/databaseConfigHelper.js"></script>
    <script src="../database/databaseModule.js"></script>

    <!-- Core Utilities -->
    <script src="../shared/config/moduleRegistry.js"></script>
    <script src="../shared/config/constants.js"></script>
    <script src="../shared/utils/logger.js"></script>
    <script src="../shared/utils/errorHandler.js"></script>
    <script src="../shared/utils/validators.js"></script>

    <!-- Database Services -->
    <script src="../database/services/databaseService.js"></script>
    <script src="../database/services/dataSharingService.js"></script>
    <script src="../database/services/fieldLockingService.js"></script>

    <!-- Notification Services -->
    <script src="../database/services/notificationTypeRegistry.js"></script>
    <script src="../database/services/notificationService.js"></script>
    <script src="../database/services/notificationPreferenceService.js"></script>
    <script src="../database/services/notificationChannelService.js"></script>
    <script src="../database/services/notificationProcessor.js"></script>

    <!-- Messaging Service -->
    <script src="../messaging/services/messagingService.js"></script>

    <!-- Initialize Database Module -->
    <script src="../database/initDatabase.js"></script>

    <!-- Payments Module -->
    <script src="../payments/config/paymentsConfigBase.js"></script>
    <script src="../payments/config/moneyTrackerConfig.js"></script>
    <script src="../payments/utils/configHelper.js"></script>
    <script src="../payments/paymentsModule.js"></script>
    <script src="../payments/services/stripeService.js"></script>
    <script src="../payments/services/paymentService.js"></script>
    <script src="../payments/services/subscriptionService.js"></script>
    <script src="../payments/utils/subscriptionChecker.js"></script>
    <script src="../payments/initPayments.js"></script>
    <script src="../payments/utils/waitForPaymentsInit.js"></script>
    <script src="../shared/utils/subscriptionGuard.js"></script>

    <!-- E2E Encryption Module -->
    <script src="../encryption/config/encryptionConfigBase.js"></script>
    <script src="../encryption/config/moneyTrackerEncryptionConfig.js"></script>
    <script src="../encryption/utils/encryptionConfigHelper.js"></script>
    <script src="../encryption/services/cryptoLibraryLoader.js"></script>
    <script src="../encryption/services/keyDerivationService.js"></script>
    <script src="../encryption/services/cryptoPrimitivesService.js"></script>
    <script src="../encryption/services/keyStorageService.js"></script>
    <script src="../encryption/services/historicalKeysService.js"></script>
    <script src="../encryption/services/passwordCryptoService.js"></script>
    <script src="../encryption/services/keyBackupService.js"></script>
    <script src="../encryption/services/keyManagementService.js"></script>
    <script src="../encryption/facade/encryptionFacade.js"></script>
    <script src="../encryption/facade/nullEncryptionFacade.js"></script>
    <script src="../encryption/encryptionModule.js"></script>
    <script src="../encryption/initEncryption.js"></script>

    <!-- Guards and Utilities -->
    <script src="../shared/utils/pairing-guard.js"></script>
    <script src="../shared/utils/permissionService.js"></script>
    <script src="../shared/utils/authGuard.js"></script>
    <script src="../shared/utils/networkUtils.js"></script>
    <script src="../shared/utils/offlineHandler.js"></script>
    <script src="../database/models/dataManager.js"></script>
    <script src="../database/models/monthFactory.js"></script>
    <script src="../shared/services/calculationService.js"></script>
    <script src="../shared/services/formHandler.js"></script>
    <script src="../shared/services/tableRenderer.js"></script>
    <script src="../shared/utils/formatters.js"></script>
    <script src="../shared/services/fileService.js"></script>
    <script src="../shared/services/exportService.js"></script>
    <script src="../shared/header/header.js"></script>
    <script src="utils/initialData.js"></script>

    <script>
        console.log('[Landing] Script initialization starting...');

        document.addEventListener('DOMContentLoaded', async function() {
            try {
                console.log('[Landing] Starting initialization...');

                if (window.CryptoLibraryLoader && typeof window.CryptoLibraryLoader.load === 'function') {
                    await window.CryptoLibraryLoader.load();
                    await window.CryptoPrimitivesService.initialize();
                    console.log('[Landing] Encryption module initialized');
                }

                const [paymentsReady, dbInitResult] = await Promise.all([
                    window.waitForPaymentsInit ? window.waitForPaymentsInit() : Promise.resolve(),
                    window.DatabaseService.initialize()
                ]);
                console.log('[Landing] Payments and Database initialized');

                const isAuthenticated = await window.AuthGuard.checkAuth();
                if (!isAuthenticated) {
                    console.log('[Landing] Not authenticated, redirecting...');
                    return;
                }
                console.log('[Landing] Authentication check passed');

                if (window.PairingGuard) {
                    console.log('[Landing] Checking device pairing status...');
                    const isPaired = await window.PairingGuard.checkPairingStatus();
                    if (!isPaired) {
                        console.log('[Landing] Device not paired - redirecting to pairing page...');
                        window.location.href = '../messaging/views/device-pairing.html';
                        return;
                    }
                    console.log('[Landing] Device pairing check passed');
                }

                await DataManager.initializeSettings();
                await DataManager.applyFontSize();
                console.log('[Landing] Settings initialized');

                await InitialData.initializeIfEmpty();
                console.log('[Landing] Initial data checked');

                window.landingControllerInitialized = true;

                if (window.LandingController) {
                    await window.LandingController.init();
                    console.log('[Landing] LandingController initialized');
                }

                console.log('[Landing] Initialization complete!');
            } catch (error) {
                console.error('[Landing] Initialization error:', error);
                const tbody = document.getElementById('months-comparison-tbody');
                if (tbody) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="9" class="text-center py-8 text-danger">
                                <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                                <p>Failed to load data. Please refresh the page.</p>
                            </td>
                        </tr>
                    `;
                }
            }
        });
    </script>
    <script src="controllers/landingController.js"></script>
</body>
</html>
