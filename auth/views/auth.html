<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Money Tracker - Sign In</title>
    <link rel="stylesheet" href="../../shared/vendor/font-awesome/css/all.min.css">
    <link rel="stylesheet" href="../../shared/styles/main-compiled.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script>
        (function() {
            console.log('[Auth] Font size initialization...');
            const cachedFontSize = localStorage.getItem('money_tracker_fontSize');
            document.documentElement.style.fontSize = (cachedFontSize || '16') + 'px';
        })();
    </script>
</head>
<body class="auth-container">
    <main class="auth-card" role="main">
        <header class="auth-header">
            <div class="auth-logo">
                <i class="fas fa-wallet"></i>
            </div>
            <h1 class="auth-title">Money Tracker</h1>
        </header>

        <section class="auth-body">
            <div class="tab-group">
                <button class="tab tab-active" data-tab="signin">Sign In</button>
                <button class="tab" data-tab="signup">Sign Up</button>
            </div>

            <!-- Sign In Form -->
            <form id="signin-form" class="auth-form active">
                <div class="form-group">
                    <label for="signin-email" class="label">Email</label>
                    <input type="email" id="signin-email" name="email" class="input" required autocomplete="email">
                    <div class="form-error hidden" id="signin-email-error"></div>
                </div>

                <div class="form-group">
                    <label for="signin-password" class="label">Password</label>
                    <input type="password" id="signin-password" name="password" class="input" required autocomplete="current-password">
                    <div class="form-error hidden" id="signin-password-error"></div>
                </div>

                <div class="form-error hidden" id="signin-error"></div>
                <div class="status-success hidden" id="signin-success"></div>

                <button type="submit" class="btn btn-primary w-full mt-4" id="signin-button">
                    Sign In
                </button>
            </form>

            <!-- Sign Up Form -->
            <form id="signup-form" class="auth-form hidden">
                <div class="form-group">
                    <label for="signup-email" class="label">Email</label>
                    <input type="email" id="signup-email" name="email" class="input" required autocomplete="email">
                    <div class="form-error hidden" id="signup-email-error"></div>
                </div>

                <div class="form-group">
                    <label for="signup-password" class="label">Password</label>
                    <input type="password" id="signup-password" name="password" class="input" required autocomplete="new-password" minlength="6">
                    <div class="form-error hidden" id="signup-password-error"></div>
                </div>

                <div class="form-group">
                    <label for="signup-password-confirm" class="label">Confirm Password</label>
                    <input type="password" id="signup-password-confirm" name="password-confirm" class="input" required autocomplete="new-password" minlength="6">
                    <div class="form-error hidden" id="signup-password-confirm-error"></div>
                </div>

                <div class="status-info hidden" id="signup-info"></div>
                <div class="form-error hidden" id="signup-error"></div>
                <div class="status-success hidden" id="signup-success"></div>

                <button type="submit" class="btn btn-primary w-full mt-4" id="signup-button">
                    Sign Up
                </button>
            </form>

        </section>

        <!-- Device Pairing UI -->
        <div id="device-pairing-section" class="hidden">
                <div class="text-center mb-6">
                    <h2 class="text-xl font-semibold text-slate-800 mb-2">Encrypting Your Data</h2>
                    <p class="text-slate-500">Setting up end-to-end encryption for complete privacy</p>
                </div>

                <div id="pairing-setup-view" class="text-center py-8">
                    <div class="spinner mx-auto mb-4"></div>
                    <p class="text-slate-600 text-lg mb-4">Generating encryption keys...</p>
                    <p class="text-slate-500 text-sm">All your data will be encrypted. Only you can access it.</p>
                </div>

                <div id="pairing-success-view" class="hidden text-center py-8">
                    <div class="text-success text-4xl mb-4"><i class="fas fa-check-circle"></i></div>
                    <p class="text-success text-lg mb-4">Encryption keys generated successfully!</p>
                    <p class="text-slate-500">Your data is now fully encrypted. Redirecting...</p>
                </div>

                <div id="pairing-error-view" class="hidden text-center py-8">
                    <div class="text-danger text-4xl mb-4"><i class="fas fa-exclamation-triangle"></i></div>
                    <p class="text-danger text-lg mb-4">Encryption setup failed</p>
                    <p id="pairing-error-message" class="text-slate-500 mb-4"></p>
                    <button id="retry-pairing-btn" class="btn btn-primary">Try Again</button>
                </div>

                <div id="pairing-multi-device-view" class="hidden py-6">
                    <div class="text-center mb-6">
                        <h2 class="text-lg font-semibold text-slate-800 mb-2">Encryption Required</h2>
                        <p class="text-slate-600 mb-2">All data in Money Tracker is fully encrypted.</p>
                        <p class="text-slate-500 text-sm">You have encryption keys on another device. You must sync your encryption keys to access your data.</p>
                    </div>

                    <button id="pair-with-qr-btn" class="btn btn-primary btn-lg w-full">
                        <i class="fas fa-camera mr-2"></i>
                        Pair This Device
                    </button>

                    <div class="text-center mt-6 pt-6 border-t border-slate-200">
                        <p class="text-slate-500 text-sm">All your data is end-to-end encrypted. Only you have the keys to decrypt your information.</p>
                    </div>
                </div>

                <!-- Recovery Key Modal -->
                <div id="recovery-key-modal" class="modal-overlay hidden">
                    <div class="modal-content max-w-lg">
                        <div class="modal-header">
                            <h2 class="modal-title">Save Your Recovery Key</h2>
                        </div>
                        <div class="modal-body">
                            <div class="status-warning mb-4">
                                <i class="fas fa-exclamation-triangle"></i>
                                <div>
                                    <strong>Write down these 24 words and store them safely.</strong><br>
                                    If you forget your password, this is the ONLY way to recover your data.
                                </div>
                            </div>

                            <div class="recovery-key-display mb-4" id="recovery-key-display-container">
                                <pre id="recovery-key-display" class="whitespace-pre-wrap"></pre>
                                <textarea id="recovery-key-edit" class="input hidden" rows="5" placeholder="Enter your custom 24-word recovery key..."></textarea>
                            </div>

                            <div id="recovery-key-word-count-display" class="text-sm text-slate-500 hidden mb-4">
                                Word count: <span id="recovery-key-custom-count">0</span> / 24
                            </div>

                            <div class="flex gap-2 mb-4">
                                <button id="edit-recovery-key-btn" class="btn btn-secondary flex-1 btn-sm">
                                    <i class="fas fa-edit"></i> Customize
                                </button>
                                <button id="copy-recovery-key-btn" class="btn btn-secondary flex-1 btn-sm">
                                    <i class="fas fa-copy"></i> Copy
                                </button>
                                <button id="download-recovery-key-btn" class="btn btn-secondary flex-1 btn-sm">
                                    <i class="fas fa-download"></i> Download
                                </button>
                                <button id="print-recovery-key-btn" class="btn btn-secondary flex-1 btn-sm">
                                    <i class="fas fa-print"></i> Print
                                </button>
                            </div>

                            <label class="checkbox-label mb-4">
                                <input type="checkbox" id="recovery-key-saved-checkbox" class="checkbox">
                                <span>I have saved my recovery key in a safe place</span>
                            </label>
                        </div>
                        <div class="modal-footer">
                            <button id="recovery-key-continue-btn" class="btn btn-primary w-full" disabled>
                                Continue to App
                            </button>
                        </div>
                    </div>
                </div>
        </div>
    </main>

    <!-- Global Logging Configuration -->
    <script src="../../shared/config/loggingConfig.js"></script>
    <script src="../../database/config/supabaseConfig.js"></script>
    <script src="../../shared/services/authService.js"></script>

    <!-- Database Module -->
    <script src="../../database/config/databaseConfigBase.js"></script>
    <script src="../../database/config/moneyTrackerDatabaseConfig.js"></script>
    <script src="../../database/utils/databaseConfigHelper.js"></script>
    <script src="../../database/databaseModule.js"></script>

    <!-- Core Utilities -->
    <script src="../../shared/config/moduleRegistry.js"></script>
    <script src="../../shared/config/constants.js"></script>
    <script src="../../shared/utils/logger.js"></script>
    <script src="../../shared/utils/errorHandler.js"></script>
    <script src="../../shared/utils/validators.js"></script>

    <!-- Database Services -->
    <script src="../../database/services/databaseService.js"></script>
    <script src="../../database/services/dataSharingService.js"></script>
    <script src="../../database/services/fieldLockingService.js"></script>

    <!-- Notification Services -->
    <script src="../../database/services/notificationTypeRegistry.js"></script>
    <script src="../../database/services/notificationService.js"></script>
    <script src="../../database/services/notificationPreferenceService.js"></script>
    <script src="../../database/services/notificationChannelService.js"></script>
    <script src="../../database/services/notificationProcessor.js"></script>

    <!-- Initialize Database Module -->
    <script src="../../database/initDatabase.js"></script>

    <!-- Messaging Service -->
    <script src="../../messaging/services/messagingService.js"></script>

    <!-- Payments Module -->
    <script src="../../payments/config/paymentsConfigBase.js"></script>
    <script src="../../payments/config/moneyTrackerConfig.js"></script>
    <script src="../../payments/utils/configHelper.js"></script>
    <script src="../../payments/paymentsModule.js"></script>
    <script src="../../payments/services/stripeService.js"></script>
    <script src="../../payments/services/paymentService.js"></script>
    <script src="../../payments/services/subscriptionService.js"></script>
    <script src="../../payments/utils/subscriptionChecker.js"></script>
    <script src="../../payments/initPayments.js"></script>
    <script src="../../payments/utils/waitForPaymentsInit.js"></script>

    <!-- E2E Encryption Module -->
    <script src="../../encryption/config/encryptionConfigBase.js"></script>
    <script src="../../encryption/config/moneyTrackerEncryptionConfig.js"></script>
    <script src="../../encryption/utils/encryptionConfigHelper.js"></script>
    <script src="../../encryption/services/cryptoLibraryLoader.js"></script>
    <script src="../../encryption/services/keyDerivationService.js"></script>
    <script src="../../encryption/services/cryptoPrimitivesService.js"></script>
    <script src="../../encryption/services/keyStorageService.js"></script>
    <script src="../../encryption/services/historicalKeysService.js"></script>
    <script src="../../encryption/services/passwordCryptoService.js"></script>
    <script src="../../encryption/services/keyBackupService.js"></script>
    <script src="../../encryption/services/keyManagementService.js"></script>
    <script src="../../encryption/facade/encryptionFacade.js"></script>
    <script src="../../encryption/facade/nullEncryptionFacade.js"></script>
    <script src="../../encryption/encryptionModule.js"></script>
    <script src="../../encryption/initEncryption.js"></script>

    <!-- Device Pairing -->
    <script src="../../messaging/services/devicePairingService.js"></script>
    <script src="../../shared/utils/pairing-guard.js"></script>
    <script src="../../shared/utils/passwordManager.js"></script>
    <script src="../../shared/utils/authGuard.js"></script>
    <script src="../../shared/header/header.js"></script>

    <script>
        console.log('[Auth] Script initialization starting...');

        let authServiceInitialized = false;
        let redirectCheckDone = false;
        let initializationInProgress = false;
        let initializationPromise = null;

        async function initializeAuth() {
            if (initializationInProgress && initializationPromise) {
                console.log('[Auth] Initialization already in progress, waiting...');
                return await initializationPromise;
            }

            if (authServiceInitialized) {
                console.log('[Auth] AuthService already initialized');
                return;
            }

            console.log('[Auth] initializeAuth() called');
            initializationInProgress = true;

            initializationPromise = (async () => {
                try {
                    if (!window.AuthService) {
                        console.error('[Auth] AuthService not available');
                        return;
                    }

                    let waitCount = 0;
                    while (!window.SupabaseConfig && waitCount < 50) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                        waitCount++;
                    }

                    if (!window.SupabaseConfig) {
                        console.error('[Auth] SupabaseConfig not available');
                        return;
                    }

                    await window.AuthService.initialize();
                    authServiceInitialized = true;
                    console.log('[Auth] AuthService initialized');

                    await new Promise(resolve => setTimeout(resolve, 200));

                    if (!redirectCheckDone) {
                        redirectCheckDone = true;

                        try {
                            const session = await window.AuthService.client.auth.getSession();
                            if (session.data?.session) {
                                window.AuthService.session = session.data.session;
                                window.AuthService.currentUser = session.data.session.user;
                            }
                        } catch (sessionError) {
                            console.warn('[Auth] Error getting session:', sessionError);
                        }

                        if (window.AuthService.isAuthenticated()) {
                            console.log('[Auth] User already authenticated, checking encryption setup...');
                            await handlePostSignIn();
                        }
                    }
                } catch (error) {
                    console.error('[Auth] Error initializing auth:', error);
                } finally {
                    initializationInProgress = false;
                }
            })();

            return await initializationPromise;
        }

        // Tab switching
        const tabs = document.querySelectorAll('.tab');
        const forms = document.querySelectorAll('.auth-form');

        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const targetTab = tab.dataset.tab;

                tabs.forEach(t => {
                    t.classList.remove('tab-active');
                    t.classList.add('tab');
                });
                tab.classList.add('tab-active');

                forms.forEach(f => f.classList.add('hidden'));
                document.getElementById(`${targetTab}-form`).classList.remove('hidden');

                clearErrors();
            });
        });

        function clearErrors() {
            document.querySelectorAll('.form-error, .status-success, .status-info, .status-warning').forEach(el => {
                el.classList.add('hidden');
                el.textContent = '';
            });
            document.querySelectorAll('.input-error').forEach(el => el.classList.remove('input-error'));
        }

        function showError(elementId, message) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = message;
                element.classList.remove('hidden');
            }
        }

        function showSuccess(elementId, message) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = message;
                element.classList.remove('hidden');
            }
        }

        function showInfo(elementId, message) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = message;
                element.classList.remove('hidden');
            }
        }

        function setButtonLoading(buttonId, loading) {
            const button = document.getElementById(buttonId);
            if (button) {
                button.disabled = loading;
                if (loading) {
                    button.innerHTML = '<span class="spinner spinner-sm mr-2"></span>Processing...';
                } else {
                    button.textContent = buttonId === 'signin-button' ? 'Sign In' : 'Sign Up';
                }
            }
        }

        function showRecoveryKeyModal(recoveryKey, onConfirm) {
            return new Promise((resolve) => {
                const modal = document.getElementById('recovery-key-modal');
                const displayEl = document.getElementById('recovery-key-display');
                const editEl = document.getElementById('recovery-key-edit');
                const wordCountDisplay = document.getElementById('recovery-key-word-count-display');
                const wordCountSpan = document.getElementById('recovery-key-custom-count');
                const checkboxEl = document.getElementById('recovery-key-saved-checkbox');
                const continueBtn = document.getElementById('recovery-key-continue-btn');
                const editBtn = document.getElementById('edit-recovery-key-btn');
                const copyBtn = document.getElementById('copy-recovery-key-btn');
                const downloadBtn = document.getElementById('download-recovery-key-btn');
                const printBtn = document.getElementById('print-recovery-key-btn');

                let currentRecoveryKey = recoveryKey;
                let isEditMode = false;
                const originalRecoveryKey = recoveryKey;

                displayEl.textContent = recoveryKey;
                modal.classList.remove('hidden');
                modal.style.display = 'flex';

                checkboxEl.checked = false;
                continueBtn.disabled = true;

                checkboxEl.onchange = () => {
                    if (isEditMode) {
                        const words = editEl.value.trim().toLowerCase().split(/\s+/).filter(w => w.length > 0);
                        continueBtn.disabled = !checkboxEl.checked || words.length !== 24;
                    } else {
                        continueBtn.disabled = !checkboxEl.checked;
                    }
                };

                editBtn.onclick = () => {
                    if (!isEditMode) {
                        isEditMode = true;
                        displayEl.classList.add('hidden');
                        editEl.classList.remove('hidden');
                        wordCountDisplay.classList.remove('hidden');
                        editEl.value = currentRecoveryKey;
                        editBtn.innerHTML = '<i class="fas fa-undo"></i> Use Generated';
                        editEl.dispatchEvent(new Event('input'));
                        const words = editEl.value.trim().toLowerCase().split(/\s+/).filter(w => w.length > 0);
                        continueBtn.disabled = !checkboxEl.checked || words.length !== 24;
                    } else {
                        isEditMode = false;
                        currentRecoveryKey = originalRecoveryKey;
                        displayEl.textContent = originalRecoveryKey;
                        displayEl.classList.remove('hidden');
                        editEl.classList.add('hidden');
                        wordCountDisplay.classList.add('hidden');
                        editBtn.innerHTML = '<i class="fas fa-edit"></i> Customize';
                        continueBtn.disabled = !checkboxEl.checked;
                    }
                };

                editEl.oninput = () => {
                    const text = editEl.value.trim().toLowerCase();
                    const words = text ? text.split(/\s+/).filter(w => w.length > 0) : [];
                    const wordCount = words.length;
                    wordCountSpan.textContent = wordCount;

                    if (wordCount === 24) {
                        wordCountDisplay.classList.add('text-success');
                        wordCountDisplay.classList.remove('text-slate-500');
                        currentRecoveryKey = words.join(' ');
                        continueBtn.disabled = !checkboxEl.checked;
                    } else {
                        wordCountDisplay.classList.remove('text-success');
                        wordCountDisplay.classList.add('text-slate-500');
                        continueBtn.disabled = true;
                        checkboxEl.checked = false;
                    }
                };

                copyBtn.onclick = async () => {
                    try {
                        await navigator.clipboard.writeText(currentRecoveryKey);
                        copyBtn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                        setTimeout(() => { copyBtn.innerHTML = '<i class="fas fa-copy"></i> Copy'; }, 2000);
                    } catch (err) {
                        console.error('Failed to copy:', err);
                    }
                };

                downloadBtn.onclick = () => {
                    const blob = new Blob([`Money Tracker Recovery Key\n\nSave these 24 words in a safe place:\n\n${currentRecoveryKey}\n\nDate: ${new Date().toISOString()}\n\nIMPORTANT: This is the ONLY way to recover your data if you forget your password.`], { type: 'text/plain' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `money-tracker-recovery-key-${Date.now()}.txt`;
                    a.click();
                    URL.revokeObjectURL(url);
                };

                printBtn.onclick = () => {
                    const printWindow = window.open('', '_blank');
                    printWindow.document.write(`<html><head><title>Money Tracker Recovery Key</title><style>body{font-family:Arial,sans-serif;padding:40px;}h1{color:#333;}.recovery-key{font-family:'Courier New',monospace;font-size:16px;line-height:2;background:#f5f5f5;padding:20px;border:2px solid #333;margin:20px 0;}.warning{color:#d32f2f;font-weight:bold;}</style></head><body><h1>Money Tracker Recovery Key</h1><p class="warning">KEEP THIS SAFE AND SECURE</p><p>If you forget your password, these 24 words are the ONLY way to recover your data.</p><div class="recovery-key">${currentRecoveryKey}</div><p>Date: ${new Date().toISOString()}</p></body></html>`);
                    printWindow.document.close();
                    printWindow.print();
                };

                continueBtn.onclick = async () => {
                    continueBtn.disabled = true;
                    continueBtn.innerHTML = '<span class="spinner spinner-sm mr-2"></span>Processing...';
                    try {
                        await onConfirm(currentRecoveryKey);
                        resolve();
                    } catch (error) {
                        console.error('[Auth] Recovery key error:', error);
                        alert('Failed to complete setup: ' + error.message);
                        continueBtn.disabled = false;
                        continueBtn.textContent = 'Continue to App';
                    }
                };
            });
        }

        async function handlePostSignIn() {
            console.log('[Auth] POST SIGN-IN CHECK');

            try {
                if (window.CryptoLibraryLoader && typeof window.CryptoLibraryLoader.load === 'function') {
                    await window.CryptoLibraryLoader.load();
                    await window.CryptoPrimitivesService.initialize();
                }

                if (window.DatabaseService && typeof window.DatabaseService.initialize === 'function') {
                    await window.DatabaseService.initialize();
                }

                MoneyTrackerEncryptionConfig.prepareWithServices();

                if (window.KeyStorageService && typeof window.KeyStorageService.initialize === 'function') {
                    await window.KeyStorageService.initialize(MoneyTrackerEncryptionConfig);
                }

                const currentUser = window.AuthService.getCurrentUser();
                if (!currentUser) {
                    window.location.href = '../../landing/index.html';
                    return;
                }

                const userId = currentUser.id;
                let keys = await window.KeyStorageService.getIdentityKeys(userId);

                if (keys && keys.publicKey && keys.secretKey) {
                    console.log('[Auth] Encryption keys found - redirecting');
                    window.location.href = '../../landing/index.html';
                    return;
                }

                const password = window.PasswordManager?.retrieve();
                if (password) {
                    await window.KeyManagementService.initialize(userId, MoneyTrackerEncryptionConfig);

                    try {
                        await window.KeyManagementService.restoreFromPassword(password);
                        window.PasswordManager?.clear();
                        window.location.href = '../../landing/index.html';
                        return;
                    } catch (restoreError) {
                        if (restoreError.message && restoreError.message.includes('No password backup found')) {
                            await setupDeviceEncryption(userId);
                        } else {
                            await setupDeviceEncryption(userId);
                        }
                    }
                } else {
                    await setupDeviceEncryption(userId);
                }

            } catch (error) {
                console.error('[Auth] POST SIGN-IN CHECK FAILED:', error);
                window.location.href = '../../messaging/views/device-pairing.html';
            }
        }

        async function setupDeviceEncryption(userId) {
            console.log('[Auth] SETTING UP DEVICE ENCRYPTION');

            document.querySelectorAll('.auth-form').forEach(el => el.classList.add('hidden'));
            document.querySelector('.tab-group').classList.add('hidden');
            document.getElementById('device-pairing-section').classList.remove('hidden');
            document.getElementById('pairing-setup-view').classList.remove('hidden');
            document.getElementById('pairing-success-view').classList.add('hidden');
            document.getElementById('pairing-error-view').classList.add('hidden');

            try {
                if (window.CryptoLibraryLoader && typeof window.CryptoLibraryLoader.load === 'function') {
                    await window.CryptoLibraryLoader.load();
                    await window.CryptoPrimitivesService.initialize();
                }

                if (window.DatabaseService && typeof window.DatabaseService.initialize === 'function') {
                    await window.DatabaseService.initialize();
                }

                MoneyTrackerEncryptionConfig.prepareWithServices();

                if (window.KeyStorageService && typeof window.KeyStorageService.initialize === 'function') {
                    await window.KeyStorageService.initialize(MoneyTrackerEncryptionConfig);
                }

                const initResult = await window.KeyManagementService.initialize(userId, MoneyTrackerEncryptionConfig);

                if (!initResult.success && initResult.needsRestore) {
                    window.location.href = '../../messaging/views/device-pairing.html?restore=true';
                    return;
                }

                if (!initResult.keysExist) {
                    const keyResult = await window.KeyManagementService.generateAndStoreIdentityKeys(userId);
                    if (!keyResult.success) {
                        throw new Error('Failed to generate encryption keys');
                    }
                }

                const recoveryKeyB64 = window.PasswordCryptoService.generateRecoveryKey();
                const recoveryKeyFormatted = window.PasswordCryptoService.formatRecoveryKey(recoveryKeyB64);

                const password = window.PasswordManager?.retrieve();
                if (!password) {
                    throw new Error('Password not available for key encryption');
                }

                await showRecoveryKeyModal(recoveryKeyFormatted, async (finalRecoveryKey) => {
                    const recoveryKeyToUse = finalRecoveryKey === recoveryKeyFormatted
                        ? recoveryKeyB64
                        : window.PasswordCryptoService.parseRecoveryKey(finalRecoveryKey);

                    await window.KeyManagementService.createDualBackup(password, recoveryKeyToUse);

                    const deviceName = window.DevicePairingService?.getDeviceName() || 'Primary Device';
                    await window.DevicePairingService.registerDevice(userId, deviceName, true);

                    window.PasswordManager?.clear();

                    document.getElementById('recovery-key-modal').style.display = 'none';
                    document.getElementById('pairing-setup-view').classList.add('hidden');
                    document.getElementById('pairing-success-view').classList.remove('hidden');

                    setTimeout(() => {
                        window.location.href = '../../landing/index.html';
                    }, 1500);
                });

            } catch (error) {
                console.error('[Auth] ENCRYPTION SETUP FAILED:', error);

                const isMultiDeviceError = error.message && error.message.includes('encryption keys exist on another device');

                if (isMultiDeviceError) {
                    document.getElementById('pairing-setup-view').classList.add('hidden');
                    document.getElementById('pairing-error-view').classList.add('hidden');
                    document.getElementById('pairing-multi-device-view').classList.remove('hidden');

                    const qrBtn = document.getElementById('pair-with-qr-btn');
                    if (qrBtn) {
                        qrBtn.onclick = () => {
                            window.location.href = '../../messaging/views/device-pairing.html';
                        };
                    }
                } else {
                    document.getElementById('pairing-setup-view').classList.add('hidden');
                    document.getElementById('pairing-error-view').classList.remove('hidden');

                    const errorMsg = document.getElementById('pairing-error-message');
                    if (errorMsg) {
                        errorMsg.textContent = error.message || 'An error occurred during encryption setup';
                    }

                    const retryBtn = document.getElementById('retry-pairing-btn');
                    if (retryBtn) {
                        retryBtn.onclick = async () => {
                            document.getElementById('pairing-error-view').classList.add('hidden');
                            document.getElementById('pairing-setup-view').classList.remove('hidden');
                            await setupDeviceEncryption(userId);
                        };
                    }
                }
            }
        }

        // Sign In Form Handler
        document.getElementById('signin-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            console.log('[Auth] SIGN IN FORM SUBMITTED');

            clearErrors();

            if (!authServiceInitialized) {
                await initializeAuth();
            }

            if (!window.AuthService || !window.AuthService.client) {
                showError('signin-error', 'Authentication service not available. Please refresh the page.');
                return;
            }

            const email = document.getElementById('signin-email').value.trim();
            const password = document.getElementById('signin-password').value;

            if (!email) {
                showError('signin-email-error', 'Email is required');
                return;
            }

            if (!password) {
                showError('signin-password-error', 'Password is required');
                return;
            }

            setButtonLoading('signin-button', true);

            try {
                const result = await window.AuthService.signIn(email, password);

                if (result.success) {
                    console.log('[Auth] SIGN IN SUCCESSFUL');
                    showSuccess('signin-success', 'Sign in successful!');

                    if (window.PasswordManager) {
                        window.PasswordManager.storeTemporarily(password);
                    }

                    setTimeout(async () => {
                        await handlePostSignIn();
                    }, 1000);
                } else {
                    if (result.error && result.error.includes('email') && result.error.includes('confirm')) {
                        showError('signin-error', 'Please verify your email address before signing in.');
                    } else {
                        showError('signin-error', result.error || 'Sign in failed. Please try again.');
                    }
                }
            } catch (error) {
                console.error('[Auth] Sign in exception:', error);
                showError('signin-error', error.message || 'An unexpected error occurred.');
            } finally {
                setButtonLoading('signin-button', false);
            }
        });

        // Sign Up Form Handler
        document.getElementById('signup-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            console.log('[Auth] SIGNUP FORM SUBMITTED');

            clearErrors();

            if (!authServiceInitialized) {
                await initializeAuth();
            }

            const email = document.getElementById('signup-email').value.trim();
            const password = document.getElementById('signup-password').value;
            const passwordConfirm = document.getElementById('signup-password-confirm').value;

            if (!email) {
                showError('signup-email-error', 'Email is required');
                return;
            }

            if (!password) {
                showError('signup-password-error', 'Password is required');
                return;
            }

            if (password.length < 6) {
                showError('signup-password-error', 'Password must be at least 6 characters');
                return;
            }

            if (password !== passwordConfirm) {
                showError('signup-password-confirm-error', 'Passwords do not match');
                return;
            }

            setButtonLoading('signup-button', true);

            try {
                const result = await window.AuthService.signUp(email, password);

                if (result.success) {
                    if (result.requiresEmailVerification) {
                        showInfo('signup-info', result.message || 'Account created! Please check your email to verify your account.');
                        setTimeout(() => {
                            document.querySelector('[data-tab="signin"]').click();
                        }, 3000);
                    } else if (result.user && window.AuthService.isAuthenticated()) {
                        showSuccess('signup-success', 'Account created successfully! Signing you in...');
                        redirectCheckDone = true;

                        setTimeout(() => {
                            window.location.href = '../../messaging/views/device-pairing.html';
                        }, 2000);
                    } else {
                        showInfo('signup-info', result.message || 'Account created successfully! Please sign in.');
                        setTimeout(() => {
                            document.querySelector('[data-tab="signin"]').click();
                        }, 2000);
                    }
                } else {
                    showError('signup-error', result.error || 'Sign up failed. Please try again.');
                }
            } catch (error) {
                console.error('[Auth] Sign up exception:', error);
                showError('signup-error', 'An unexpected error occurred. Please try again.');
            } finally {
                setButtonLoading('signup-button', false);
            }
        });

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async () => {
            if (window.CryptoLibraryLoader && typeof window.CryptoLibraryLoader.load === 'function') {
                try {
                    await window.CryptoLibraryLoader.load();
                    await window.CryptoPrimitivesService.initialize();
                } catch (error) {
                    console.warn('[Auth] Failed to initialize Encryption Module:', error);
                }
            }

            await initializeAuth();
        });
    </script>
</body>
</html>
