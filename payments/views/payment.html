<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subscription & Payment - Money Tracker</title>
    <link rel="stylesheet" href="../../ui/vendor/font-awesome/css/all.min.css">
    <link rel="stylesheet" href="../../ui/styles/main.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script src="https://js.stripe.com/v3/"></script>
    <script>
        // Load font size IMMEDIATELY from localStorage cache to prevent FOUC
        (function() {
            const cachedFontSize = localStorage.getItem('money_tracker_fontSize');
            document.documentElement.style.fontSize = (cachedFontSize || '16') + 'px';
            
            // Sync with database once services are available
            async function syncFontSizeFromDatabase() {
                try {
                    if (window.DatabaseService && window.AuthService && window.AuthService.isAuthenticated()) {
                        const settings = await window.DatabaseService.getSettings();
                        if (settings && settings.fontSize) {
                            const fontSize = settings.fontSize;
                            document.documentElement.style.fontSize = fontSize + 'px';
                            localStorage.setItem('money_tracker_fontSize', fontSize);
                        }
                    } else if (document.readyState !== 'complete') {
                        setTimeout(syncFontSizeFromDatabase, 100);
                    }
                } catch (error) {
                    // Silently fail - use cached value
                }
            }
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', syncFontSizeFromDatabase);
            } else {
                syncFontSizeFromDatabase();
            }
        })();
    </script>
    <style>
        .payment-main {
            max-width: 900px;
            margin: 0 auto;
            padding: var(--spacing-md);
            padding-top: calc(2rem + 70px);
            padding-bottom: 2rem;
        }
        
        .subscription-section {
            background-color: rgba(213, 213, 213, 0.85);
            padding: var(--spacing-md);
            border-radius: var(--border-radius);
            border: var(--border-width-thin) solid var(--border-color-black);
            margin-bottom: var(--spacing-md);
        }
        
        .subscription-status-container {
            margin-bottom: var(--spacing-md);
        }
        
        .subscription-message {
            padding: var(--spacing-sm);
            border-radius: var(--border-radius);
            margin-bottom: var(--spacing-sm);
            font-weight: 500;
        }
        
        .subscription-message-info {
            background-color: rgba(123, 171, 138, 0.2);
            border: var(--border-width-standard) solid var(--success-color);
            color: var(--text-primary);
        }
        
        .subscription-message-success {
            background-color: rgba(123, 171, 138, 0.3);
            border: var(--border-width-standard) solid var(--success-color);
            color: var(--text-primary);
        }
        
        .subscription-message-error {
            background-color: rgba(181, 138, 138, 0.2);
            border: var(--border-width-standard) solid var(--danger-color);
            color: var(--text-primary);
        }
        
        .payment-history-section {
            background-color: rgba(213, 213, 213, 0.85);
            padding: var(--spacing-md);
            border-radius: var(--border-radius);
            border: var(--border-width-thin) solid var(--border-color-black);
        }
        
        .table-container {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .data-table {
            width: 100%;
            min-width: 100%;
            table-layout: auto;
        }
        
        .data-table th,
        .data-table td {
            padding: var(--spacing-xs) var(--spacing-sm);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .data-table th:first-child,
        .data-table td:first-child {
            min-width: 100px;
        }
        
        .data-table th:nth-child(2),
        .data-table td:nth-child(2) {
            min-width: 80px;
        }
        
        .data-table th:nth-child(3),
        .data-table td:nth-child(3) {
            min-width: 90px;
        }
        
        .data-table th:last-child,
        .data-table td:last-child {
            min-width: 150px;
            max-width: 200px;
        }
        
        @media (max-width: 768px) {
            .data-table {
                font-size: 0.9rem;
            }
            
            .data-table th,
            .data-table td {
                padding: var(--spacing-xs);
                font-size: 0.85rem;
            }
            
            .data-table th:last-child,
            .data-table td:last-child {
                max-width: 120px;
            }
        }
        
        .payment-status-pending {
            color: #f59e0b;
            font-weight: 500;
        }
        
        .payment-status-success {
            color: var(--success-color);
            font-weight: 500;
        }
        
        .payment-status-error {
            color: var(--danger-color);
            font-weight: 500;
        }
        
        .section-title {
            margin-bottom: var(--spacing-md);
            color: var(--text-primary);
        }
        
        .button-group {
            display: flex;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-sm);
        }
    </style>
</head>
<body>
    <!-- Header will be injected by Header.js -->

    <main class="payment-main" role="main">
        <section class="hero-section">
            <h2 class="hero-title">Subscription & Payment</h2>
        </section>

        <section class="subscription-section form-section">
            <h2 class="section-title">Subscription</h2>
            
            <div id="subscription-status-container" class="subscription-status-container">
                <div id="subscription-status-message" class="subscription-message" style="padding: var(--spacing-sm); border-radius: var(--border-radius); margin-bottom: var(--spacing-sm);">
                    Loading subscription status...
                </div>
                
                <div id="subscription-details" class="subscription-details" style="display: none; margin-top: var(--spacing-md); padding: var(--spacing-md); background: rgba(213, 213, 213, 0.85); border: var(--border-width-thin) solid var(--border-color-black); border-radius: var(--border-radius);">
                    <div id="subscription-details-content" style="display: grid; gap: var(--spacing-sm); font-size: 0.95rem;">
                        <!-- Details will be populated by JavaScript -->
                    </div>
                </div>
                
                <div id="account-created-container" class="account-created-container" style="display: none; margin-top: var(--spacing-md); padding: var(--spacing-sm); font-size: 0.95rem;">
                    <strong>Account Created:</strong> <span id="account-created-date"></span>
                </div>
            </div>
            
            <div class="settings-row" style="gap: 0.5rem; margin-top: var(--spacing-sm); width: 100%; max-width: 100%; box-sizing: border-box;">
                <button id="start-subscription-button" class="btn btn-action" style="display: none;">
                    Start Subscription (â‚¬5/month)
                </button>
                <button id="refresh-subscription-button" class="btn btn-action">
                    Refresh Status
                </button>
            </div>
            
            <div id="subscription-status" class="settings-status"></div>
        </section>

        <section class="payment-history-section form-section">
            <h2 class="section-title">Payment History</h2>
            
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Amount</th>
                            <th>Status</th>
                            <th>Payment ID</th>
                        </tr>
                    </thead>
                    <tbody id="payment-history-tbody">
                        <tr>
                            <td colspan="4" style="text-align: center;">Loading payment history...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>
    </main>

    <!-- Load scripts in order -->
    <script src="../../database/config/supabase-config.js"></script>
    <script src="../../ui/services/AuthService.js"></script>
    <script src="../../database/services/database-service.js"></script>
    <script src="../config/stripe-config.js"></script>
    <script src="../services/StripeService.js"></script>
    <script src="../services/SubscriptionService.js"></script>
    <script src="../services/PaymentService.js"></script>
    <script src="../utils/subscription-checker.js"></script>
    <script src="../../ui/components/Header.js"></script>
    <script src="../controllers/PaymentController.js"></script>
    
    <script>
        // Initialize page when DOM is ready
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Initialize AuthService first
                if (window.AuthService) {
                    await window.AuthService.initialize();
                }
                
                // Wait for session to be checked (session check runs in background)
                // Poll for authentication status with timeout
                let authenticated = false;
                const maxWaitTime = 5000; // 5 seconds max wait
                const checkInterval = 100; // Check every 100ms
                const startTime = Date.now();
                
                while (!authenticated && (Date.now() - startTime) < maxWaitTime) {
                    if (window.AuthService && window.AuthService.isAuthenticated()) {
                        authenticated = true;
                        break;
                    }
                    await new Promise(resolve => setTimeout(resolve, checkInterval));
                }
                
                // Check authentication after waiting
                if (!window.AuthService || !window.AuthService.isAuthenticated()) {
                    console.log('[PaymentPage] User not authenticated, redirecting to auth...');
                    // Use absolute URL to avoid path resolution issues
                    const baseUrl = window.location.origin;
                    const currentPath = window.location.pathname;
                    const pathParts = currentPath.split('/').filter(p => p && p !== 'index.html');
                    
                    // Find the base path (everything before 'ui' or 'payments')
                    let basePathParts = [];
                    for (let i = 0; i < pathParts.length; i++) {
                        if (pathParts[i] === 'ui' || pathParts[i] === 'payments') {
                            break;
                        }
                        basePathParts.push(pathParts[i]);
                    }
                    
                    const basePath = basePathParts.length > 0 ? basePathParts.join('/') + '/' : '';
                    const authUrl = `${baseUrl}/${basePath}ui/views/auth.html`;
                    console.log('[PaymentPage] Redirecting to auth:', authUrl);
                    window.location.href = authUrl;
                    return;
                }
                
                // Initialize DatabaseService
                if (window.DatabaseService) {
                    await window.DatabaseService.initialize();
                }
                
                // Initialize PaymentController
                if (window.PaymentController) {
                    await window.PaymentController.init();
                }
                
                // Handle payment return from Stripe
                const urlParams = new URLSearchParams(window.location.search);
                const paymentStatus = urlParams.get('payment');
                if (paymentStatus === 'success') {
                    alert('Payment successful! Your subscription is now active.');
                    // Refresh subscription data
                    if (window.PaymentController) {
                        await window.PaymentController.refreshSubscriptionData();
                    }
                    // Remove query parameter
                    window.history.replaceState({}, document.title, window.location.pathname);
                } else if (paymentStatus === 'cancelled') {
                    alert('Payment was cancelled. You can try again when ready.');
                    // Remove query parameter
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            } catch (error) {
                console.error('[PaymentPage] Initialization error:', error);
                alert('Error initializing payment page. Please refresh and try again.');
            }
        });
    </script>
</body>
</html>

