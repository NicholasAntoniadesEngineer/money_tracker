# Claude Code - Project Instructions

This file contains important guidelines and conventions for this project.

## Git Commit Conventions

### ❌ CRITICAL: No AI Co-Author Attribution
**NEVER add `Co-Authored-By: Claude` or any AI attribution in commit messages.**

The repository owner prefers commits without AI co-author lines.

**Correct:**
```
Implement password-encrypted key backup system

Added secure PBKDF2-based key derivation and AES-256-GCM encryption
for backing up E2E encryption keys to database.
```

**INCORRECT:**
```
Implement password-encrypted key backup system

Added secure PBKDF2-based key derivation...

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>  ❌ NEVER DO THIS
```

### Commit Message Format
- **First line**: Short summary (50 chars or less)
- **Body**: Detailed explanation if needed
- Use present tense ("Add feature" not "Added feature")
- Reference issue numbers when applicable

## Code Style Conventions

### JavaScript
- Use ES6+ syntax (const/let, arrow functions, async/await)
- Avoid `var` declarations
- Use `window.` prefix for global service access
- Always use semicolons
- Use 4-space indentation (matches existing code)

### File Organization
```
/database/        - Database schemas, migrations, services
/messaging/       - Messaging and E2E encryption
/auth/           - Authentication views
/shared/         - Shared utilities and services
/landing/        - Landing/home page
```

### Naming Conventions
- **Services**: PascalCase with "Service" suffix (e.g., `AuthService`)
- **Controllers**: PascalCase with "Controller" suffix (e.g., `MessengerController`)
- **Utilities**: camelCase (e.g., `formatters.js`)
- **Constants**: UPPER_SNAKE_CASE

## Security Requirements

### End-to-End Encryption
- **NEVER** store plaintext private keys in database
- **NEVER** send plaintext keys to server
- Use PBKDF2-SHA256 with ≥600,000 iterations (OWASP 2023)
- Use AES-256-GCM for authenticated encryption
- Validate all encryption parameters before use

### Password Handling
- **NEVER** store passwords permanently
- Use sessionStorage for temporary storage (max 10 minutes)
- Clear password from memory immediately after use
- Always use Web Crypto API for cryptographic operations

### Input Validation
- Sanitize all user inputs
- Validate on both client and server side
- Use parameterized queries for database operations
- Escape HTML output to prevent XSS

## Database Conventions

### Migrations
- Sequential numbering: `01-name.sql`, `02-name.sql`, etc.
- Always include rollback instructions in comments
- Test migrations on dev environment first
- Include descriptive headers explaining purpose

### Table Naming
- Use snake_case (e.g., `user_key_backups`)
- Singular names for lookup tables
- Always enable Row Level Security (RLS)
- Include timestamps: `created_at`, `updated_at`

### RLS Policies
- Always create policies for SELECT, INSERT, UPDATE, DELETE
- Use `auth.uid()` for user-specific access
- Name policies descriptively: `tablename_action_scope`

## Testing Guidelines

### Before Committing
1. Test in development environment (file://)
2. Test on localhost
3. Test on production (GitHub Pages)
4. Clear localStorage and test first-time user flow
5. Test cross-device functionality

### Manual Testing Checklist
- [ ] Login/logout flow works
- [ ] Device pairing works (primary device)
- [ ] Device pairing works (secondary device with code)
- [ ] Key backup created after setup
- [ ] Key restoration works after localStorage clear
- [ ] Messages encrypt/decrypt correctly
- [ ] Console shows no errors

## Error Handling

### Logging
- Use console.log for informational messages
- Use console.warn for recoverable issues
- Use console.error for errors
- Include service name in brackets: `[ServiceName] Message`

### User Feedback
- Show clear, actionable error messages
- Never expose technical details to users
- Provide fallback instructions when operations fail
- Use alerts sparingly (only for critical issues)

## File Path Conventions

### Script Loading Order (in HTML)
1. Global logging config
2. Database config and services
3. Auth services
4. Crypto libraries (in dependency order)
5. Business logic services
6. Controllers
7. Page-specific initialization

### Relative Paths
From `/messaging/views/`:
- `../../shared/` - Shared utilities
- `../../database/` - Database services
- `../crypto/` - Crypto services (same module)
- `../services/` - Messaging services (same module)

## Performance Best Practices

### Script Loading
- Load critical scripts first
- Use async/defer when appropriate
- Minimize script count (but maintain modularity)
- Cache results of expensive operations

### Database Queries
- Use indexes on frequently queried columns
- Limit query results when possible
- Use RLS for security (not for performance optimization)
- Batch operations when appropriate

## Documentation Standards

### Code Comments
- Explain WHY, not WHAT
- Document security-critical sections
- Include references to RFCs/standards when applicable
- Update comments when code changes

### Function Documentation
```javascript
/**
 * Brief description of what function does
 *
 * @param {type} paramName - Description
 * @returns {type} Description
 * @throws {Error} When this happens
 */
```

## Branch Workflow

### Feature Branches
- Branch from `master` (or specified base)
- Name format: `feature/descriptive-name`
- Keep branches focused on single feature
- Merge via pull request when complete

### Commit Frequency
- Commit logical units of work
- Don't commit broken code
- Commit before major refactoring
- Use meaningful commit messages

## Common Pitfalls to Avoid

1. ❌ Don't use `var` - use `const` or `let`
2. ❌ Don't store secrets in code - use environment variables
3. ❌ Don't skip error handling - always handle errors gracefully
4. ❌ Don't use innerHTML with user input - sanitize first
5. ❌ Don't commit without testing - test locally first
6. ❌ Don't add AI co-author attribution - see above ⬆️

## Resources

- [OWASP Top 10](https://owasp.org/www-project-top-ten/)
- [Web Crypto API](https://developer.mozilla.org/en-US/docs/Web/API/Web_Crypto_API)
- [Supabase Docs](https://supabase.com/docs)
- [TweetNaCl.js](https://github.com/dchest/tweetnacl-js)

---

**Last Updated**: January 2026
**Maintainer**: Nicholas Antoniades
