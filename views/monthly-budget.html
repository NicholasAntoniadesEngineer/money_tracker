<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monthly Budget - Money Tracker</title>
    <link rel="stylesheet" href="../styles/main.css">
    <link rel="icon" href="data:,">
</head>
<body>
    <!-- Header will be injected by Header.js -->

    <main class="budget-main" role="main">
        <section class="hero-section">
            <h2 class="hero-title">Monthly Budget</h2>
        </section>

        <section class="month-selector-section form-section">
            <div class="form-group">
                <label for="month-selector" class="form-label">Select Month:</label>
                <div style="display: flex; gap: 0.5rem; align-items: flex-end; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 200px;">
                <select id="month-selector" class="form-select">
                    <option value="">Loading...</option>
                </select>
                    </div>
                    <button id="create-month-button" class="btn btn-primary">Create New Month</button>
                    <button id="delete-month-button" class="btn btn-danger" style="display: none;">Delete Month</button>
                </div>
            </div>
            
            <div class="form-group" style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                <label class="form-label">File Operations:</label>
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center;">
                    <button id="load-months-button" class="btn btn-secondary">Load Months from Files</button>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <label for="export-format-select" style="color: var(--text-primary); font-size: 0.9rem;">Export Format:</label>
                        <select id="export-format-select" class="btn btn-secondary" style="padding: 0.5rem 1rem; cursor: pointer; background-color: var(--surface-overlay-button); color: var(--text-black); border: 1px solid var(--border-color); border-radius: var(--border-radius);">
                            <option value="json">JSON</option>
                            <option value="csv">CSV</option>
                            <option value="html">HTML</option>
                        </select>
                        <button id="export-current-month-button" class="btn btn-secondary">Export Current Month</button>
                        <button id="export-all-months-button" class="btn btn-secondary">Export All Months</button>
                    </div>
                    <input type="file" id="file-input" multiple accept=".json,.csv,.html" style="display: none;">
                </div>
                <p class="form-help-text" style="margin-top: 0.5rem; font-size: 0.85rem; color: var(--text-secondary);">
                    <strong>Load Months from Files:</strong> Click to select the <code>data/months/</code> folder (modern browsers) or individual JSON/CSV/HTML files (all browsers).<br/>
                    <strong>Export Current Month:</strong> Export the currently selected month in the selected format (JSON, CSV, or HTML).<br/>
                    <strong>Export All Months:</strong> Export all months in the selected format (JSON, CSV, or HTML).<br/>
                    <em>Note: You can load JSON, CSV, and HTML files. CSV and HTML files will be automatically imported. HTML export creates formatted reports.</em>
                </p>
                <div id="file-operations-status" style="margin-top: 0.5rem; font-size: 0.9rem;"></div>
            </div>
        </section>

        <div id="month-content" style="display: none;">
            <section class="month-header-section">
                <h2 id="month-title" class="section-title"></h2>
            </section>

            <section class="working-section form-section">
                <h2 class="section-title">The Working Section (The Important One)</h2>
                <p class="section-description">The heart of the system — split into weekly blocks. Each week shows payments due, groceries (with running calculations), transport (with running calculations), activities (with running calculations), and weekly estimate/actual for joint account.</p>
                <table class="data-table" id="weekly-breakdown-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Payments Due</th>
                            <th>Groceries</th>
                            <th>Transport</th>
                            <th>Activities</th>
                            <th>Estimate</th>
                            <th>Actual</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="weekly-breakdown-tbody">
                        <tr class="total-row">
                            <td><strong>TOTALS</strong></td>
                            <td id="weekly-breakdown-total-payments"></td>
                            <td id="weekly-breakdown-total-groceries"></td>
                            <td id="weekly-breakdown-total-transport"></td>
                            <td id="weekly-breakdown-total-activities"></td>
                            <td id="weekly-breakdown-total-estimate"><strong>£0.00</strong></td>
                            <td id="weekly-breakdown-total-actual"><strong>£0.00</strong></td>
                            <td></td>
                        </tr>
                    </tbody>
                </table>
                <div style="text-align: right; margin-top: 1rem;">
                    <button id="add-weekly-breakdown-button" class="btn btn-secondary">Add Week</button>
                </div>
            </section>

            <section class="income-section form-section">
                <h2 class="section-title">1. Income Overview (Estimated vs Actual)</h2>
                <p class="section-description">At the start of each month, write down how much you expect to earn, how much I expect to earn, and any other income.</p>
                <table class="data-table" id="income-table">
                    <thead>
                        <tr>
                            <th>Revenue Source</th>
                            <th>Estimated Amount</th>
                            <th>Actual Amount</th>
                            <th>Date</th>
                            <th>Description</th>
                            <th>Comments</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="income-tbody">
                    </tbody>
                </table>
                <div style="text-align: right; margin-top: 1rem;">
                    <button id="add-income-button" class="btn btn-secondary">Add Income Source</button>
                </div>
            </section>

            <section class="fixed-costs-section form-section">
                <h2 class="section-title">2. Fixed Costs (Recurring Bills)</h2>
                <p class="section-description">All predictable expenses that come out every month — rent, subscriptions, gym, storage, transport, etc. Track estimated, actual, date, and which card.</p>
                <table class="data-table" id="fixed-costs-table">
                    <thead>
                        <tr>
                            <th>Expense Category</th>
                            <th>Estimated Amount</th>
                            <th>Actual Amount</th>
                            <th>Date</th>
                            <th>Card</th>
                            <th>Paid</th>
                            <th>Comments</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="fixed-costs-tbody">
                    </tbody>
                </table>
                <div style="text-align: right; margin-top: 1rem;">
                    <button id="add-fixed-cost-button" class="btn btn-secondary">Add Fixed Cost</button>
                </div>
            </section>

            <section class="variable-costs-section form-section">
                <h2 class="section-title">3. Variable Costs (Food + Activities)</h2>
                <p class="section-description">The two categories we can control. Assign a monthly budget for each.</p>
                <table class="data-table" id="variable-costs-table">
                    <thead>
                        <tr>
                            <th>Category</th>
                            <th>Monthly Budget</th>
                            <th>Actual Spent</th>
                            <th>Remaining</th>
                            <th>Comments</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="variable-costs-tbody">
                    </tbody>
                </table>
                <div style="text-align: right; margin-top: 1rem;">
                    <button id="add-variable-cost-button" class="btn btn-secondary">Add Variable Cost</button>
                </div>
            </section>

            <section class="unplanned-expenses-section form-section">
                <h2 class="section-title">4. Unplanned Buying</h2>
                <p class="section-description">Catch-all section for things we didn't budget for but end up buying anyway (new jeans, spontaneous book, one-off fee, anything unexpected).</p>
                <table class="data-table" id="unplanned-expenses-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Amount</th>
                            <th>Date</th>
                            <th>Card</th>
                            <th>Status</th>
                            <th>Comments</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="unplanned-expenses-tbody">
                    </tbody>
                </table>
                <div style="text-align: right; margin-top: 1rem;">
                    <button id="add-unplanned-expense-button" class="btn btn-secondary">Add Unplanned Expense</button>
                </div>
            </section>

            <section class="summary-section form-section">
                <h2 class="section-title">5. End-of-Month Summary</h2>
                <p class="section-description">All income minus all expenses (fixed + variable + unplanned) = what's left over / the savings total for the month.</p>
                <table class="data-table" id="summary-table">
                    <thead>
                        <tr>
                            <th>Category</th>
                            <th>Estimated Amount</th>
                            <th>Actual Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Total Income</strong></td>
                            <td id="summary-income-estimated"><strong>£0.00</strong></td>
                            <td id="summary-income-actual"><strong>£0.00</strong></td>
                        </tr>
                        <tr>
                            <td>Total Fixed Costs</td>
                            <td id="summary-fixed-costs-estimated">£0.00</td>
                            <td id="summary-fixed-costs-actual">£0.00</td>
                        </tr>
                        <tr>
                            <td>Total Variable Costs</td>
                            <td id="summary-variable-costs-estimated">£0.00</td>
                            <td id="summary-variable-costs-actual">£0.00</td>
                        </tr>
                        <tr>
                            <td><strong>Total Expenses</strong></td>
                            <td id="summary-expenses-estimated"><strong>£0.00</strong></td>
                            <td id="summary-expenses-actual"><strong>£0.00</strong></td>
                        </tr>
                        <tr>
                            <td>Total Unplanned Expenses</td>
                            <td>—</td>
                            <td id="summary-unplanned-actual">£0.00</td>
                        </tr>
                        <tr class="total-row">
                            <td><strong><em>Grand Savings Total</em></strong></td>
                            <td id="summary-savings-estimated"><strong><em>£0.00</em></strong></td>
                            <td id="summary-savings-actual"><strong><em>£0.00</em></strong></td>
                        </tr>
                    </tbody>
                </table>
            </section>

            <section class="save-section form-section">
                <h3 class="section-title">Save Data</h3>
                <p class="section-description" style="font-size: 0.9rem; margin-bottom: 1rem;">
                    <strong>Data Storage:</strong> All data is stored as individual JSON files in <code>data/months/</code> folder.<br/>
                    When you save, the file will be saved directly (modern browsers) or downloaded (older browsers).
                </p>
                <button id="save-month-button" class="btn btn-primary btn-success" style="font-size: 1.25rem; padding: 1rem 2rem;">Save Month Data</button>
            </section>
        </div>

        <div id="no-month-message" style="text-align: center; padding: 3rem;">
            <p class="empty-message">No month selected. Please select a month from the dropdown or create a new one.</p>
        </div>
    </main>

    <footer class="main-footer" role="contentinfo">
        <p>&copy; 2025 Money Tracker. All data stored locally in your browser.</p>
    </footer>

    <script src="../models/DataManager.js"></script>
    <script src="../utils/formatters.js"></script>
    <script src="../components/Header.js"></script>
    <script src="../utils/CSVHandler.js"></script>
    <script src="../utils/ReferenceImporter.js"></script>
    <script src="../utils/InitialData.js"></script>
    <script src="../controllers/MonthlyBudgetController.js"></script>
    <script>
        // Initialize settings
        DataManager.initializeSettings();
        
        // Verify ReferenceImporter is loaded
        if (!window.ReferenceImporter) {
            console.error('ReferenceImporter not loaded! HTML file imports will not work.');
        } else {
            console.log('ReferenceImporter loaded successfully');
        }
        
        // Verify CSVHandler is loaded
        if (!window.CSVHandler) {
            console.error('CSVHandler not loaded! CSV export/import will not work.');
        } else {
            console.log('CSVHandler loaded successfully');
        }
        
        // Initialize controller when DOM is ready
        document.addEventListener('DOMContentLoaded', async function() {
            // Now initialize the controller (it will handle loading months)
            if (window.MonthlyBudgetController) {
                await window.MonthlyBudgetController.init();
            }
        });
    </script>
</body>
</html>

