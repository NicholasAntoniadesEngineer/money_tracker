<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monthly Budget - Money Tracker</title>
    <link rel="stylesheet" href="../styles/main.css">
    <link rel="icon" href="data:,">
</head>
<body>
    <!-- Header will be injected by Header.js -->

    <main class="budget-main" role="main">
        <section class="hero-section">
            <h2 class="hero-title">Monthly Budget</h2>
        </section>

        <section class="month-selector-section form-section">
            <div class="month-header-container">
                <div class="month-title-wrapper" id="month-title-wrapper" style="display: none;">
                    <h2 id="month-title" class="month-title"></h2>
                    <select id="month-selector" class="month-selector-compact">
                        <option value="">Loading...</option>
                    </select>
                </div>
                <div class="month-selector-wrapper" id="month-selector-wrapper">
                    <label for="month-selector-initial" class="form-label">Select Month:</label>
                    <select id="month-selector-initial" class="form-select">
                        <option value="">Loading...</option>
                    </select>
                </div>
                <div class="month-buttons-container">
                    <button id="load-example-button" class="btn btn-action">Load Example</button>
                <button id="create-month-button" class="btn btn-primary create-month-btn">Create New Month</button>
                </div>
            </div>
        </section>

        <div id="month-content" style="display: none;">

            <section class="working-section form-section">
                <h2 class="section-title">The Working Section</h2>
                <table class="data-table" id="weekly-breakdown-table">
                    <thead id="weekly-breakdown-thead">
                        <tr>
                            <th>Date</th>
                            <th>Payments Due </th>
                            <th>Estimate</th>
                            <th>Actual</th>
                            <th class="delete-column-header"></th>
                        </tr>
                    </thead>
                    <tbody id="weekly-breakdown-tbody">
                        <tr class="total-row">
                            <td><strong>TOTALS</strong></td>
                            <td id="weekly-breakdown-total-payments"></td>
                            <td id="weekly-breakdown-total-estimate"><strong>£0.00</strong></td>
                            <td id="weekly-breakdown-total-actual"><strong>£0.00</strong></td>
                            <td></td>
                        </tr>
                    </tbody>
                </table>
                <div style="text-align: right; margin-top: 1rem;">
                    <button id="add-weekly-breakdown-button" class="btn btn-action" style="display: none;">Add Week</button>
                    <small style="color: var(--text-secondary); font-style: italic;">Weeks are automatically generated based on the calendar month</small>
                </div>
            </section>

            <section class="income-section form-section">
                <div style="margin-bottom: 1rem;">
                    <h2 class="section-title" style="margin: 0;">1. Income</h2>
                    <p class="section-description" style="margin: 0.5rem 0 0 0;">At the start of each month, write down how much you expect to earn, how much I expect to earn, and any other income.</p>
                </div>
                <table class="data-table" id="income-table">
                    <thead>
                        <tr>
                            <th>Revenue Source</th>
                            <th>Estimated Amount</th>
                            <th>Actual Amount</th>
                            <th>Date</th>
                            <th>Description</th>
                            <th>Comments</th>
                            <th class="delete-column-header"></th>
                        </tr>
                    </thead>
                    <tbody id="income-tbody">
                    </tbody>
                </table>
                <div class="section-actions-container" style="text-align: right; margin-top: 1rem; display: flex; gap: 0.5rem; justify-content: flex-end; align-items: center;">
                    <select id="copy-income-from-month" class="form-select copy-month-select">
                        <option value="">Select month to copy...</option>
                    </select>
                    <button id="copy-income-button" class="btn btn-action">Copy</button>
                    <button id="add-income-button" class="btn btn-action">Add Income Source</button>
                </div>
            </section>

            <section class="fixed-costs-section form-section">
                <div style="margin-bottom: 1rem;">
                    <h2 class="section-title" style="margin: 0;">2. Fixed Costs (Recurring Bills)</h2>
                    <p class="section-description" style="margin: 0.5rem 0 0 0;">All predictable expenses that come out every month — rent, subscriptions, gym, storage, transport, etc. Track estimated, actual, date, and which card.</p>
                </div>
                <table class="data-table" id="fixed-costs-table">
                    <thead>
                        <tr>
                            <th>Expense Category</th>
                            <th>Estimated Amount</th>
                            <th>Actual Amount</th>
                            <th>Date</th>
                            <th>Card</th>
                            <th>Paid</th>
                            <th>Comments</th>
                            <th class="delete-column-header"></th>
                        </tr>
                    </thead>
                    <tbody id="fixed-costs-tbody">
                    </tbody>
                </table>
                <div class="section-actions-container" style="text-align: right; margin-top: 1rem; display: flex; gap: 0.5rem; justify-content: flex-end; align-items: center;">
                    <select id="copy-fixed-costs-from-month" class="form-select copy-month-select">
                        <option value="">Select month to copy...</option>
                    </select>
                    <button id="copy-fixed-costs-button" class="btn btn-action">Copy</button>
                    <button id="add-fixed-cost-button" class="btn btn-action">Add Fixed Cost</button>
                </div>
            </section>

            <section class="variable-costs-section form-section">
                <div style="margin-bottom: 1rem;">
                    <h2 class="section-title" style="margin: 0;">3. Variable Costs (Food + Activities)</h2>
                    <p class="section-description" style="margin: 0.5rem 0 0 0;">The two categories we can control. Assign a monthly budget for each.</p>
                </div>
                <table class="data-table" id="variable-costs-table">
                    <thead>
                        <tr>
                            <th>Category</th>
                            <th>Monthly Budget</th>
                            <th>Actual Spent</th>
                            <th>Remaining</th>
                            <th>Comments</th>
                            <th class="delete-column-header"></th>
                        </tr>
                    </thead>
                    <tbody id="variable-costs-tbody">
                    </tbody>
                </table>
                <div class="section-actions-container" style="text-align: right; margin-top: 1rem; display: flex; gap: 0.5rem; justify-content: flex-end; align-items: center;">
                    <select id="copy-variable-costs-from-month" class="form-select copy-month-select">
                        <option value="">Select month to copy...</option>
                    </select>
                    <button id="copy-variable-costs-button" class="btn btn-action">Copy</button>
                    <button id="add-variable-cost-button" class="btn btn-action">Add Variable Cost</button>
                </div>
            </section>

            <section class="unplanned-expenses-section form-section">
                <div style="margin-bottom: 1rem;">
                    <h2 class="section-title" style="margin: 0;">4. Unplanned Buying</h2>
                    <p class="section-description" style="margin: 0.5rem 0 0 0;">Catch-all section for things we didn't budget for but end up buying anyway (new jeans, spontaneous book, one-off fee, anything unexpected).</p>
                </div>
                <table class="data-table" id="unplanned-expenses-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Amount</th>
                            <th>Date</th>
                            <th>Card</th>
                            <th>Paid</th>
                            <th>Comments</th>
                            <th class="delete-column-header"></th>
                        </tr>
                    </thead>
                    <tbody id="unplanned-expenses-tbody">
                    </tbody>
                </table>
                <div class="section-actions-container" style="text-align: right; margin-top: 1rem; display: flex; gap: 0.5rem; justify-content: flex-end; align-items: center;">
                    <select id="copy-unplanned-from-month" class="form-select copy-month-select">
                        <option value="">Select month to copy...</option>
                    </select>
                    <button id="copy-unplanned-button" class="btn btn-action">Copy</button>
                    <button id="add-unplanned-expense-button" class="btn btn-action">Add Unplanned Expense</button>
                </div>
            </section>

            <section class="summary-section form-section">
                <h2 class="section-title">5. End-of-Month Summary</h2>
                <p class="section-description">All income minus all expenses (fixed + variable + unplanned) = what's left over / the savings total for the month.</p>
                <table class="data-table" id="summary-table">
                    <thead>
                        <tr>
                            <th>Category</th>
                            <th>Estimated Amount</th>
                            <th>Actual Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Total Income</strong></td>
                            <td id="summary-income-estimated"><strong>£0.00</strong></td>
                            <td id="summary-income-actual"><strong>£0.00</strong></td>
                        </tr>
                        <tr>
                            <td>Total Fixed Costs</td>
                            <td id="summary-fixed-costs-estimated">£0.00</td>
                            <td id="summary-fixed-costs-actual">£0.00</td>
                        </tr>
                        <tr>
                            <td>Total Variable Costs</td>
                            <td id="summary-variable-costs-estimated">£0.00</td>
                            <td id="summary-variable-costs-actual">£0.00</td>
                        </tr>
                        <tr>
                            <td><strong>Total Expenses</strong></td>
                            <td id="summary-expenses-estimated"><strong>£0.00</strong></td>
                            <td id="summary-expenses-actual"><strong>£0.00</strong></td>
                        </tr>
                        <tr>
                            <td>Total Unplanned Expenses</td>
                            <td>—</td>
                            <td id="summary-unplanned-actual">£0.00</td>
                        </tr>
                        <tr class="total-row">
                            <td><strong><em>Grand Savings Total</em></strong></td>
                            <td id="summary-savings-estimated"><strong><em>£0.00</em></strong></td>
                            <td id="summary-savings-actual"><strong><em>£0.00</em></strong></td>
                        </tr>
                    </tbody>
                </table>
            </section>

            <section class="save-section form-section">
                <h3 class="section-title">Save Data</h3>
                <p class="section-description" style="font-size: 0.9rem; margin-bottom: 1rem;">
                    <strong>Data Storage:</strong> All data is stored as individual JSON files in <code>data/months/</code> folder.<br/>
                    When you save, the file will be saved directly (modern browsers) or downloaded (older browsers).
                </p>
                <button id="save-month-button" class="btn btn-primary btn-success">Save Month Data</button>
            </section>
        </div>

        <div id="no-month-message" style="text-align: center; padding: 3rem;">
            <p class="empty-message">No month selected. Please select a month from the dropdown or create a new one.</p>
        </div>
    </main>

    <footer class="main-footer" role="contentinfo">
        <p>&copy; 2025 Money Tracker. All data stored locally in your browser.</p>
    </footer>

    <script src="../models/StorageService.js"></script>
    <script src="../models/MonthFactory.js"></script>
    <script src="../services/CalculationService.js"></script>
    <script src="../services/FormHandler.js"></script>
    <script src="../services/TableRenderer.js"></script>
    <script src="../utils/formatters.js"></script>
    <script src="../utils/CSVHandler.js"></script>
    <script src="../utils/ReferenceImporter.js"></script>
    <script src="../services/FileService.js"></script>
    <script src="../services/ExportService.js"></script>
    <script src="../models/DataManager.js"></script>
    <script src="../components/Header.js"></script>
    <script src="../utils/InitialData.js"></script>
    <script src="../controllers/MonthlyBudgetController.js"></script>
    <script>
        // Initialize settings
        DataManager.initializeSettings();
        
        // Verify ReferenceImporter is loaded
        if (!window.ReferenceImporter) {
            console.error('ReferenceImporter not loaded! HTML file imports will not work.');
        } else {
            console.log('ReferenceImporter loaded successfully');
        }
        
        // Verify CSVHandler is loaded
        if (!window.CSVHandler) {
            console.error('CSVHandler not loaded! CSV export/import will not work.');
        } else {
            console.log('CSVHandler loaded successfully');
        }
        
        // Initialize controller when DOM is ready
        document.addEventListener('DOMContentLoaded', async function() {
            // Now initialize the controller (it will handle loading months)
            if (window.MonthlyBudgetController) {
                await window.MonthlyBudgetController.init();
            }
        });
    </script>
</body>
</html>

